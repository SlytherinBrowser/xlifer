<!doctype html>
<html lang="sl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini Snapchat ‚Äì prijatelji, chat in zemljevid</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>

<style>
  :root{
    --dock-bg:#111827;        /* slate-900 */
    --dock-fg:#e5e7eb;        /* gray-200 */
    --accent:#22c55e;         /* green-500 */
    --danger:#ef4444;         /* red-500 */
    --ring:#334155;           /* slate-700 */
  }

  *{box-sizing:border-box}
  html, body {height:100%; margin:0; background:#0b1020; color:#e5e7eb; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;}

  /* App layout */
  #app{position:fixed; inset:0; display:none;}
  #map{position:absolute; inset:0;}
  .emoji-label{
    background: rgba(17,24,39,.9);
    color:#e5e7eb;
    padding:2px 6px;
    border-radius:12px;
    font-size:12px;
    margin-top:2px;
    text-align:center;
    white-space:nowrap;
  }

  /* Dock */
  #dock{
    position:fixed; left:0; right:0; bottom:0;
    background:var(--dock-bg); color:var(--dock-fg);
    border-top:1px solid #1f2937;
    transition:height .2s ease;
    display:flex; flex-direction:column;
    box-shadow:0 -10px 30px rgba(0,0,0,.35);
    max-height:85vh;
    height:72px; /* shrunk default */
  }
  .dock-content{
    padding:12px 14px 10px; overflow:auto; display:none;
  }
  .dock-toolbar{
    display:none; grid-template-columns:1fr auto 1fr; gap:10px;
    align-items:center; padding:8px 12px;
    border-top:1px solid #1f2937; background:#0f172a;
  }
  .dock-buttons{
    display:flex; gap:10px; justify-content:space-around; padding:10px 12px;
    border-top:1px solid #1f2937; background:#0f172a;
  }
  button{
    appearance:none; border:1px solid #1f2937; background:#0b1222; color:#e5e7eb;
    padding:10px 12px; border-radius:10px; font-weight:600; cursor:pointer;
    transition:transform .05s ease, background .2s;
  }
  button:hover{ background:#111a2e }
  button:active{ transform:translateY(1px) }
  .btn-primary{ background:linear-gradient(180deg,#22c55e,#16a34a); border-color:#15803d; }
  .btn-ghost{ background:transparent; border-color:#334155; }
  .btn-danger{ background:linear-gradient(180deg,#ef4444,#dc2626); border-color:#b91c1c; }
  .tag{ font-size:12px; padding:3px 8px; background:#0b1222; border:1px solid #1f2937; border-radius:999px; color:#9ca3af;}
  input, textarea{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--ring);
    background:#0b1222; color:#e5e7eb; outline:none;
  }
  .row{ display:flex; gap:10px; align-items:center; }
  .row > *{ flex:1 }

  /* Lists / cards */
  .list{ display:flex; flex-direction:column; gap:8px; }
  .item{
    background:#0f172a; border:1px solid #273244; border-radius:12px; padding:10px 12px;
    display:flex; align-items:center; gap:10px; justify-content:space-between;
  }
  .item .left{ display:flex; align-items:center; gap:10px;}
  .avatar{
    width:36px; height:36px; border-radius:10px; display:grid; place-items:center;
    background:#0b1222; border:1px solid #273244; font-size:20px;
  }
  .muted{ color:#94a3b8; font-size:12px }

  /* Chat */
  .chat-header{
    display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px;
  }
  .chat-box{
    background:#0f172a; border:1px solid #273244; border-radius:12px; padding:10px; height:40vh; overflow:auto;
    display:flex; flex-direction:column; gap:6px;
  }
  .msg{ max-width:80%; padding:8px 10px; border-radius:12px; }
  .me{ align-self:flex-end; background:#1c3a2b; }
  .them{ align-self:flex-start; background:#13213c; }
  .msg .time{ font-size:10px; color:#94a3b8; margin-top:2px; }

  /* Auth page */
  #auth{ position:fixed; inset:0; display:grid; place-items:center; padding:20px; }
  .panel{
    width:min(560px, 96vw);
    background:#0b1222; border:1px solid #1f2937; border-radius:16px; padding:20px;
    box-shadow:0 20px 60px rgba(0,0,0,.45);
  }
  .panel h1{ margin:0 0 10px 0; }
  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .divider{ height:1px; background:#1f2937; margin:14px 0; }

  /* Toast */
  #toast{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:92px; background:#0b1222; border:1px solid #273244; border-radius:12px;
    padding:10px 14px; display:none; box-shadow:0 10px 30px rgba(0,0,0,.35);
    z-index:1000;
  }

  .hidden{ display:none !important; }
</style>
</head>
<body>

<!-- AUTH -->
<section id="auth">
  <div class="panel">
    <h1>Prijava</h1>
    <div class="grid-2">
      <div>
        <label>E-po≈°ta</label>
        <input id="loginEmail" type="email" placeholder="ime@domena.si" />
      </div>
      <div>
        <label>Geslo</label>
        <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
    </div>
    <div class="row" style="margin-top:10px;">
      <button id="btnLogin" class="btn-primary">Prijavi me</button>
      <button id="btnAnon" class="btn-ghost" title="Hiter preizkus">Gost (demo)</button>
    </div>

    <div class="divider"></div>

    <h1>Registracija</h1>
    <div class="grid-2">
      <div><label>Ime</label><input id="regName" placeholder="Tvoje ime" /></div>
      <div><label>Rojstni datum</label><input id="regDob" type="date" /></div>
      <div><label>E-po≈°ta</label><input id="regEmail" type="email" placeholder="ime@domena.si" /></div>
      <div><label>Geslo</label><input id="regPass" type="password" placeholder="vsaj 6 znakov" /></div>
    </div>
    <div class="row" style="margin-top:10px;">
      <button id="btnRegister" class="btn-primary">Ustvari raƒçun</button>
    </div>
  </div>
</section>

<!-- APP -->
<section id="app">
  <div id="map"></div>

  <!-- Toast -->
  <div id="toast"></div>

  <!-- Dock -->
  <div id="dock">
    <!-- Dynamic content -->
    <div id="dockContent" class="dock-content"></div>

    <!-- Search toolbar (only for Search tab) -->
    <div id="searchToolbar" class="dock-toolbar">
      <button id="btnCloseSearch" class="btn-ghost">Zapri</button>
      <input id="searchInput" placeholder="I≈°ƒçi uporabnike po imenu ali e-po≈°ti‚Ä¶" />
      <button id="btnWhoAddedMe" class="btn-ghost">Kdo me je dodal</button>
    </div>

    <!-- Chat composer (only in chat) -->
    <div id="chatComposer" class="dock-toolbar">
      <input id="chatInput" placeholder="Napi≈°i sporoƒçilo‚Ä¶" />
      <button id="btnSend" class="btn-primary">Po≈°lji</button>
    </div>

    <!-- Base buttons -->
    <div class="dock-buttons">
      <button id="btnFriends">üë• Prijatelji</button>
      <button id="btnSearch">üîé Iskanje</button>
      <button id="btnProfile">üë§ Moj profil</button>
    </div>
  </div>
</section>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script>
/* =========================
   Firebase INIT
   ========================= */
// TODO: PASTE YOUR FIREBASE CONFIG HERE
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAhA1s2iiJDMMeqoOrp1asJO1eha_R0ivg",
  authDomain: "slychat1-b76db.firebaseapp.com",
  databaseURL: "https://slychat1-b76db-default-rtdb.firebaseio.com",
  projectId: "slychat1-b76db",
  storageBucket: "slychat1-b76db.firebasestorage.app",
  messagingSenderId: "508879069664",
  appId: "1:508879069664:web:ce963d111297cd3480cb85",
  measurementId: "G-D34XJNNGNQ"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* =========================
   Global app state
   ========================= */
const state = {
  me: null,
  currentView: null,       // 'friends' | 'chat' | 'profile' | 'search' | 'profileView'
  currentChat: null,
  unsub: { friends:null, chat:null, inbox:null, map:null },
  map: null,
  markers: new Map(),      // uid -> {marker}
  dockMode: 'shrunk'       // 'shrunk' | 'expanded'
};

/* =========================
   Helpers
   ========================= */
const $ = sel => document.querySelector(sel);
const el = (tag, cls, html) => { const n=document.createElement(tag); if(cls) n.className=cls; if(html!==undefined) n.innerHTML=html; return n; };

function toast(msg, timeout=3500){
  const t = $('#toast');
  t.textContent = msg;
  t.style.display='block';
  setTimeout(()=> t.style.display='none', timeout);
}
function ageFromDob(dobStr){
  if(!dobStr) return '‚Äî';
  const d = new Date(dobStr);
  if (isNaN(d)) return '‚Äî';
  const diff = Date.now()-d.getTime();
  return Math.floor(diff/31557600000);
}
function formatTime(ts){
  const d = ts?.toDate?.() ?? new Date();
  return new Date(d).toLocaleString();
}

/* =========================
   DOCK height & view mgmt
   ========================= */
function setDockShrunk(){
  state.dockMode='shrunk';
  $('#dockContent').style.display='none';
  $('#searchToolbar').style.display='none';
  $('#chatComposer').style.display='none';
  $('#dock').style.height='72px';
  if(state.map) setTimeout(()=> state.map.invalidateSize(), 200);
}
function setDockExpanded({showSearchBar=false, showChatBar=false}={}){
  state.dockMode='expanded';
  $('#dockContent').style.display='block';
  $('#searchToolbar').style.display = showSearchBar ? 'grid' : 'none';
  $('#chatComposer').style.display  = showChatBar   ? 'grid' : 'none';
  adjustDockHeight();
}
function adjustDockHeight(){
  // measure visible parts
  const base = 52; // buttons approx height
  const contentH = $('#dockContent').offsetHeight || 0;
  const searchH  = $('#searchToolbar').style.display!=='none' ? $('#searchToolbar').offsetHeight : 0;
  const chatH    = $('#chatComposer').style.display!=='none' ? $('#chatComposer').offsetHeight : 0;
  // target = content + toolbars + buttons + paddings
  let target = contentH + searchH + chatH + base + 28; // padding
  const max = Math.round(window.innerHeight * 0.85);
  target = Math.min(target, max);
  target = Math.max(target, 220); // minimum when expanded
  $('#dock').style.height = target + 'px';
  // ensure content scrolls if overflowing
  const extra = target - (searchH + chatH + base + 28);
  $('#dockContent').style.maxHeight = Math.max(extra, 100) + 'px';
  if(state.map) setTimeout(()=> state.map.invalidateSize(), 50);
}
const resizeObserver = new ResizeObserver(()=>{ if(state.dockMode==='expanded') adjustDockHeight(); });
resizeObserver.observe($('#dockContent'));

/* =========================
   MAP (Leaflet + emoji markers)
   ========================= */
function initMap(){
  if(state.map) return;
  state.map = L.map('map', { zoomControl:false }).setView([46.0569,14.5058], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom:19, attribution:'¬© OpenStreetMap'
  }).addTo(state.map);

  // prompt for location always on first load
  requestLocationPermission();

  // live users locations
  if(state.unsub.map) state.unsub.map();
  state.unsub.map = db.collection('users').onSnapshot(snap=>{
    snap.docs.forEach(doc=>{
      const u = { uid: doc.id, ...doc.data() };
      placeOrUpdateMarker(u);
    });
  });
}
function requestLocationPermission(){
  if(!('geolocation' in navigator)){
    toast('Geolokacija ni podprta v brskalniku.');
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos => updateMyLocation(pos.coords.latitude, pos.coords.longitude),
    err => {
      // poka≈æi gumb v profilu in obvesti
      console.warn(err);
      toast('Dovoli lokacijo v brskalniku (ikona kljuƒça/kljuƒçavnice).');
    },
    { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
  );
  // tudi watch za kasnej≈°e premike
  navigator.geolocation.watchPosition(
    pos => updateMyLocation(pos.coords.latitude, pos.coords.longitude),
    ()=>{}, { enableHighAccuracy:true }
  );
}
function emojiDivIcon(emoji='üë§', name=''){
  const html = `
    <div style="display:flex;flex-direction:column;align-items:center;transform:translateY(-8px);">
      <div style="font-size:26px;filter:drop-shadow(0 2px 4px rgba(0,0,0,.6));">${emoji}</div>
      <div class="emoji-label">${name||''}</div>
    </div>`;
  return L.divIcon({ html, className:'', iconSize:[40,40], iconAnchor:[20,34] });
}
function placeOrUpdateMarker(user){
  const { uid, name, emoji='üß≠', loc } = user;
  if(!loc || loc.lat==null || loc.lng==null) return;
  const exists = state.markers.get(uid);
  if(exists){
    exists.marker.setLatLng([loc.lat, loc.lng]);
    exists.marker.setIcon(emojiDivIcon(emoji, name||''));
  }else{
    const marker = L.marker([loc.lat, loc.lng], { icon: emojiDivIcon(emoji, name||'') }).addTo(state.map);
    marker.on('click', ()=> openProfileView(uid));
    state.markers.set(uid, { marker });
  }
}
async function updateMyLocation(lat, lng){
  if(!auth.currentUser) return;
  await db.collection('users').doc(auth.currentUser.uid).set({ loc:{lat,lng} }, { merge:true });
}

/* =========================
   AUTH flows
   ========================= */
$('#btnAnon').onclick = async ()=>{ await auth.signInAnonymously(); };
$('#btnLogin').onclick = async ()=>{
  const email = $('#loginEmail').value.trim();
  const pass  = $('#loginPass').value;
  try{ await auth.signInWithEmailAndPassword(email, pass); }catch(e){ alert(e.message); }
};
$('#btnRegister').onclick = async ()=>{
  const name = $('#regName').value.trim();
  const dob  = $('#regDob').value;
  const email= $('#regEmail').value.trim();
  const pass = $('#regPass').value;
  if(!name || !dob || !email || !pass){ alert('Izpolni vsa polja.'); return; }
  try{
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    await db.collection('users').doc(cred.user.uid).set({
      name, dob, email, score:0, bio:'', emoji:'üôÇ',
      loc:null, createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }catch(e){ alert(e.message); }
};

auth.onAuthStateChanged(async user=>{
  if(!user){
    $('#auth').style.display='grid';
    $('#app').style.display='none';
    return;
  }
  $('#auth').style.display='none';
  $('#app').style.display='block';

  // Ensure user doc exists
  const meDoc = await db.collection('users').doc(user.uid).get();
  if(!meDoc.exists){
    await db.collection('users').doc(user.uid).set({
      name:'Uporabnik', dob:'', email:user.email||'', score:0, bio:'', emoji:'üôÇ', loc:null
    });
  }
  const me = (await db.collection('users').doc(user.uid).get()).data();
  state.me = { uid:user.uid, ...me };

  initMap();
  wireInboxNotifications();
  setDockShrunk();
});

/* =========================
   Dock buttons
   ========================= */
$('#btnFriends').onclick = ()=>{ (state.currentView==='friends' && state.dockMode==='expanded') ? setDockShrunk() : openFriends(); };
$('#btnSearch').onclick  = ()=>{ (state.currentView==='search'  && state.dockMode==='expanded') ? setDockShrunk() : openSearch(); };
$('#btnProfile').onclick = ()=>{ (state.currentView==='profile' && state.dockMode==='expanded') ? setDockShrunk() : openMyProfile(); };

/* =========================
   Rendering helpers (ALWAYS REPLACE CONTENT)
   ========================= */
function render(contentHTML){
  const wrap = $('#dockContent');
  wrap.innerHTML = contentHTML;
  setDockExpanded({ showSearchBar: state.currentView==='search', showChatBar: state.currentView==='chat' });
}

/* =========================
   Friends list & Chat
   ========================= */
async function openFriends(){
  state.currentView='friends';
  $('#chatComposer').style.display='none';
  $('#searchToolbar').style.display='none';

  render(`<h3 style="margin:4px 2px 8px;">Prijatelji</h3>
          <div id="friendsList" class="list"></div>`);

  if(state.unsub.friends) state.unsub.friends();
  state.unsub.friends = db.collection('users').doc(auth.currentUser.uid)
    .collection('friends').onSnapshot(async snap=>{
      const elList = $('#friendsList'); elList.innerHTML='';
      if(snap.empty){
        elList.append(el('div','muted','≈†e nima≈° prijateljev. Pojdi na Iskanje üîé in dodaj koga.'));
        adjustDockHeight(); return;
      }
      for(const doc of snap.docs){
        const fuid = doc.id;
        const f = (await db.collection('users').doc(fuid).get()).data();
        const item = el('div','item');
        const left = el('div','left',`
          <div class="avatar">${f?.emoji||'üë§'}</div>
          <div>
            <div><strong>${f?.name||'Uporabnik'}</strong></div>
            <div class="muted">${f?.bio||''}</div>
          </div>
        `);
        const btns = el('div');
        const b1 = el('button','', 'Pogovor'); b1.onclick = ()=> openChat(fuid);
        const b2 = el('button','btn-ghost', 'Profil'); b2.onclick = ()=> openProfileView(fuid);
        btns.append(b1,b2);
        item.append(left, btns);
        elList.append(item);
      }
      adjustDockHeight();
    });
}

function chatIdFor(a,b){ return [a,b].sort().join('__'); }

async function openChat(friendUid){
  state.currentView='chat';
  state.currentChat = friendUid;
  $('#searchToolbar').style.display='none';

  const friend = (await db.collection('users').doc(friendUid).get()).data();

  render(`
    <div class="chat-header">
      <button class="btn-ghost" id="btnBackToFriends">‚Üê Nazaj</button>
      <div style="flex:1;text-align:center; cursor:pointer;" id="chatTitle"><strong>${friend?.name||'Uporabnik'}</strong></div>
      <span class="tag">Chat</span>
    </div>
    <div id="msgList" class="chat-box"></div>
  `);
  $('#chatComposer').style.display='grid';

  $('#btnBackToFriends').onclick = openFriends;
  $('#chatTitle').onclick = ()=> openProfileView(friendUid);

  const cid = chatIdFor(auth.currentUser.uid, friendUid);
  if(state.unsub.chat) state.unsub.chat();
  state.unsub.chat = db.collection('chats').doc(cid).collection('messages')
    .orderBy('createdAt','asc')
    .onSnapshot(snap=>{
      const list = $('#msgList'); list.innerHTML='';
      snap.docs.forEach(d=>{
        const m = d.data();
        const bubble = el('div', 'msg ' + (m.from===auth.currentUser.uid?'me':'them'));
        bubble.innerHTML = `<div>${m.text||''}</div><div class="time">${formatTime(m.createdAt)}</div>`;
        list.append(bubble);
      });
      list.scrollTop = list.scrollHeight;
      adjustDockHeight();
    });
}

$('#btnSend').onclick = async ()=>{
  const text = $('#chatInput').value.trim();
  if(!text || !state.currentChat) return;
  $('#chatInput').value = '';
  const cid = chatIdFor(auth.currentUser.uid, state.currentChat);
  await db.collection('chats').doc(cid).collection('messages').add({
    from: auth.currentUser.uid,
    to: state.currentChat,
    text,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  await db.collection('inbox').add({
    type:'message', from:auth.currentUser.uid, to: state.currentChat,
    text, createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
};

/* Inbox notifications */
function wireInboxNotifications(){
  if(state.unsub.inbox) state.unsub.inbox();
  state.unsub.inbox = db.collection('inbox')
    .where('to','==',auth.currentUser.uid)
    .orderBy('createdAt','desc').limit(1)
    .onSnapshot(async snap=>{
      if(snap.empty) return;
      const it = snap.docs[0].data();
      if(it.type==='message' && !(state.currentView==='chat' && state.currentChat===it.from)){
        const u = (await db.collection('users').doc(it.from).get()).data();
        toast(`${u?.name||'Nekdo'} ti je poslal sporoƒçilo`);
      }
      if(it.type==='friend_request'){
        const u = (await db.collection('users').doc(it.from).get()).data();
        toast(`${u?.name||'Nekdo'} te je dodal`);
      }
    });
}

/* =========================
   Profile (mine)
   ========================= */
async function openMyProfile(){
  state.currentView='profile';
  $('#searchToolbar').style.display='none';
  $('#chatComposer').style.display='none';

  const meRef = await db.collection('users').doc(auth.currentUser.uid).get();
  const me = meRef.data() || {};

  render(`
    <h3 style="margin:4px 2px 8px;">Moj profil</h3>
    <div class="list">
      <div class="item">
        <div class="left"><div class="avatar">${me?.emoji||'üôÇ'}</div>
          <div><strong>Ime</strong><div class="muted">Kako naj te prikazuje</div></div></div>
        <div style="flex:1; max-width:60%"><input id="meName" value="${(me?.name||'').replace(/"/g,'&quot;')}" /></div>
      </div>
      <div class="item">
        <div class="left"><div class="avatar">üìù</div><div><strong>Opis</strong><div class="muted">Kratek bio</div></div></div>
        <div style="flex:1; max-width:70%"><input id="meBio" value="${(me?.bio||'').replace(/"/g,'&quot;')}" /></div>
      </div>
      <div class="item">
        <div class="left"><div class="avatar">üé≠</div><div><strong>Emoji</strong><div class="muted">Za marker na zemljevidu</div></div></div>
        <div style="flex:1; max-width:40%"><input id="meEmoji" value="${(me?.emoji||'üôÇ').replace(/"/g,'&quot;')}" /></div>
      </div>
      <div class="item">
        <div class="left"><div class="avatar">üéÇ</div><div><strong>Rojstni datum</strong><div class="muted">Starost: ${ageFromDob(me?.dob)}</div></div></div>
        <span class="tag">${me?.dob || '‚Äî'}</span>
      </div>
      <div class="item">
        <div class="left"><div class="avatar">üéØ</div><div><strong>Score</strong><div class="muted">Samodejno (demo)</div></div></div>
        <span class="tag">${me?.score ?? 0}</span>
      </div>
      <div class="row">
        <button id="btnSaveMe" class="btn-primary">Shrani</button>
        <button id="btnSetLoc" class="btn-ghost">Dovoli/Osve≈æi lokacijo</button>
        <button id="btnLogout" class="btn-danger">Odjava</button>
      </div>
    </div>
  `);

  $('#btnSaveMe').onclick = async ()=>{
    const name = $('#meName').value.trim();
    const bio  = $('#meBio').value.trim();
    const emoji= $('#meEmoji').value.trim() || 'üôÇ';
    await db.collection('users').doc(auth.currentUser.uid).set({ name, bio, emoji }, { merge:true });
    toast('Profil shranjen');
    const u = (await db.collection('users').doc(auth.currentUser.uid).get()).data();
    placeOrUpdateMarker({ uid:auth.currentUser.uid, ...u });
  };
  $('#btnSetLoc').onclick = ()=> requestLocationPermission();
  $('#btnLogout').onclick = ()=> auth.signOut();
}

/* =========================
   Profile (view other)
   ========================= */
async function openProfileView(uid){
  state.currentView='profileView';
  $('#searchToolbar').style.display='none';
  $('#chatComposer').style.display='none';

  const udoc = await db.collection('users').doc(uid).get();
  const u = udoc.data();
  const isFriend = (await db.collection('users').doc(auth.currentUser.uid).collection('friends').doc(uid).get()).exists;

  render(`
    <div class="chat-header">
      <button class="btn-ghost" id="btnBackGeneric">‚Üê Nazaj</button>
      <div style="flex:1;text-align:center;"><strong>${u?.name||'Uporabnik'}</strong></div>
      <span class="tag">Profil</span>
    </div>
    <div class="list">
      <div class="item">
        <div class="left"><div class="avatar" style="font-size:34px">${u?.emoji||'üë§'}</div>
          <div>
            <div><strong>${u?.name||''}</strong></div>
            <div class="muted">Starost: ${ageFromDob(u?.dob)} ‚Ä¢ Score: ${u?.score ?? 0}</div>
          </div>
        </div>
        <div class="muted">${u?.dob||''}</div>
      </div>
      <div class="item"><div>${u?.bio||'‚Äî brez opisa ‚Äî'}</div></div>
      <div class="row">
        <button id="btnOpenChat" class="btn-ghost">Odpri chat</button>
        ${isFriend ? '' : '<button id="btnAddFriend" class="btn-primary">Dodaj</button>'}
      </div>
    </div>
  `);
  $('#btnBackGeneric').onclick = ()=>{
    if(state.currentChat===uid) openChat(uid); else openFriends();
  };
  $('#btnOpenChat').onclick = ()=> openChat(uid);
  const addBtn = $('#btnAddFriend');
  if(addBtn) addBtn.onclick = async ()=>{
    await db.collection('friend_requests').add({
      from: auth.currentUser.uid, to: uid,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    await db.collection('inbox').add({
      type:'friend_request', from: auth.currentUser.uid, to: uid,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    toast('Pro≈°nja poslana');
  };
}

/* =========================
   Search + ‚Äúkdo me je dodal‚Äù
   ========================= */
function openSearch(){
  state.currentView='search';
  $('#chatComposer').style.display='none';
  $('#searchToolbar').style.display='grid';

  render(`<div id="searchResults" class="list"></div>`);

  $('#btnCloseSearch').onclick = ()=>{ setDockShrunk(); state.currentView=null; };
  $('#btnWhoAddedMe').onclick = loadWhoAddedMe;
  $('#searchInput').oninput = debounce(doSearch, 250);
}

async function doSearch(){
  const q = $('#searchInput').value.trim().toLowerCase();
  const out = $('#searchResults'); out.innerHTML='';
  if(q.length<2){ out.append(el('div','muted','Vpi≈°i vsaj 2 znaka.')); adjustDockHeight(); return; }

  // demo: fetch 50 users and filter client-side
  const snap = await db.collection('users').limit(50).get();
  const results = snap.docs
    .map(d=>({ uid:d.id, ...d.data() }))
    .filter(u=> (u.name?.toLowerCase().includes(q) || u.email?.toLowerCase().includes(q)));

  if(results.length===0){ out.append(el('div','muted','Ni najdenih uporabnikov.')); adjustDockHeight(); return; }

  for(const u of results){
    if(u.uid===auth.currentUser.uid) continue;
    const row = el('div','item');
    row.innerHTML = `
      <div class="left">
        <div class="avatar">${u.emoji||'üë§'}</div>
        <div><div><strong>${u.name||''}</strong></div><div class="muted">${u.email||''}</div></div>
      </div>
      <div>
        <button class="btn-ghost">Profil</button>
      </div>
    `;
    row.querySelector('button').onclick = ()=> openProfileView(u.uid);
    out.append(row);
  }
  adjustDockHeight();
}

async function loadWhoAddedMe(){
  const out = $('#searchResults'); out.innerHTML = '<div class="muted">Nalagam‚Ä¶</div>';
  const snap = await db.collection('friend_requests').where('to','==',auth.currentUser.uid).get();
  out.innerHTML='';
  if(snap.empty){ out.append(el('div','muted','Trenutno te nihƒçe ni dodal.')); adjustDockHeight(); return; }
  for(const d of snap.docs){
    const fr = d.data();
    const u = (await db.collection('users').doc(fr.from).get()).data();
    const row = el('div','item');
    row.innerHTML = `
      <div class="left">
        <div class="avatar">${u?.emoji||'üë§'}</div>
        <div><div><strong>${u?.name||'Uporabnik'}</strong></div><div class="muted">${u?.email||''}</div></div>
      </div>
      <div class="row" style="gap:6px; flex:unset">
        <button class="btn-primary">Sprejmi</button>
        <button class="btn-ghost">Zavrni</button>
      </div>
    `;
    const [btnAccept, btnDecline] = row.querySelectorAll('button');
    btnAccept.onclick = async ()=>{
      const meF = db.collection('users').doc(auth.currentUser.uid).collection('friends').doc(fr.from).set({ at: firebase.firestore.FieldValue.serverTimestamp() });
      const heF = db.collection('users').doc(fr.from).collection('friends').doc(auth.currentUser.uid).set({ at: firebase.firestore.FieldValue.serverTimestamp() });
      await Promise.all([meF, heF]);
      await db.collection('friend_requests').doc(d.id).delete();
      toast('Dodano med prijatelje');
      doSearch();
    };
    btnDecline.onclick = async ()=>{
      await db.collection('friend_requests').doc(d.id).delete();
      toast('Pro≈°nja zavrnjena');
      doSearch();
    };
    out.append(row);
  }
  adjustDockHeight();
}

/* =========================
   Utilities
   ========================= */
function debounce(fn,ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms);} }
window.addEventListener('resize', ()=>{ if(state.dockMode==='expanded') adjustDockHeight(); });
document.addEventListener('visibilitychange', ()=>{ if(state.map) setTimeout(()=> state.map.invalidateSize(), 100); });

</script>

</body>
</html>