<!DOCTYPE html>
<html lang="sl" data-theme="breeze">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>xlifer ‚Äî social</title>
  <style>
    :root{ --radius:16px; --elev:0 10px 30px rgba(0,0,0,.12); --speed:180ms; --ring-1:#60a5fa; --ring-2:#a78bfa }
    /* THEMES */
    html[data-theme="breeze"]{--bg:#F7F8FA;--text:#0F172A;--card:#FFFFFF;--border:#E5E7EB;--primary:#2563EB;--accent:#22C55E;--ring-1:#60a5fa;--ring-2:#a78bfa}
    html[data-theme="midnight"]{--bg:#0B1020;--text:#E5E7EB;--card:#141A2A;--border:#1F2937;--primary:#60A5FA;--accent:#34D399;--ring-1:#22d3ee;--ring-2:#a78bfa}
    html[data-theme="obsidian"]{--bg:#000;--text:#E6E6E6;--card:#0A0A0A;--border:#1A1A1A;--primary:#4F46E5;--accent:#10B981;--ring-1:#3b82f6;--ring-2:#ec4899}
    html[data-theme="sunset"]{--bg:#1B0E0A;--text:#FDEAD7;--card:#2A1711;--border:#3A241C;--primary:#FB923C;--accent:#F59E0B;--ring-1:#fb923c;--ring-2:#f472b6}

    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:var(--primary);text-decoration:none}
    button{cursor:pointer;border:1px solid var(--border);background:var(--card);color:var(--text);padding:.7rem 1rem;border-radius:12px;transition:transform var(--speed),background var(--speed),opacity var(--speed)}
    button.primary{background:var(--primary);color:#fff;border-color:transparent}
    button.ghost{background:transparent}
    input,textarea,select{width:100%;padding:.8rem 1rem;border:1px solid var(--border);border-radius:12px;background:var(--card);color:var(--text)}
    .row{display:flex;gap:10px;align-items:center}
    .stack{display:flex;flex-direction:column;gap:10px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--elev)}
    .hide{display:none !important}

    /* Shell */
    header.appbar{position:sticky;top:0;z-index:5;background:var(--bg);backdrop-filter:saturate(120%) blur(6px);border-bottom:1px solid var(--border);padding:.6rem 1rem;display:flex;align-items:center;gap:10px}
    header.appbar h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}
    header.appbar .spacer{flex:1}

    main#app{max-width:900px;margin:0 auto;padding:14px}

    /* Auth view */
    #authView{min-height:100vh;display:grid;place-items:center;padding:20px}
    .auth-box{width:min(480px,96vw)}
    .auth-head{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    .logo{width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,var(--ring-1),var(--ring-2));}

    .hint{font-size:12px;opacity:.7}
    .divider{height:1px;background:var(--border);margin:14px 0}

    /* Stories */
    .stories{display:flex;gap:12px;overflow:auto;padding:8px 4px}
    .story{width:70px}
    .story .circle{width:64px;height:64px;border-radius:50%;background:conic-gradient(from 0deg, var(--ring-1), var(--ring-2));padding:3px}
    .story .inner{width:100%;height:100%;border-radius:50%;background:var(--bg);display:grid;place-items:center;overflow:hidden}
    .story img{width:100%;height:100%;object-fit:cover}
    .story .name{font-size:12px;text-align:center;margin-top:6px;opacity:.8}

    /* Feed */
    .feed{display:grid;gap:12px}
    .post{padding:10px}
    .post .head{display:flex;gap:10px;align-items:center}
    .avatar{width:38px;height:38px;border-radius:50%;background:#bbb;overflow:hidden}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .post .meta{font-size:12px;opacity:.7}
    .media{margin-top:10px;border-radius:12px;overflow:hidden;border:1px solid var(--border)}
    .media img{width:100%;display:block}
    .actions{display:flex;gap:10px;margin-top:8px}

    /* Bottom Dock */
    .dock{position:fixed;left:50%;transform:translateX(-50%);bottom:10px;width:70%;min-width:320px;max-width:900px;background:var(--card);border:1px solid var(--border);border-radius:20px;box-shadow:var(--elev);z-index:20;display:flex;flex-direction:column}
    .dock.collapsed{height:5px;overflow:hidden}
    .dock .handle{height:10px;display:grid;place-items:center}
    .dock .handle span{width:60px;height:4px;border-radius:4px;background:var(--border)}
    .dock .content{max-height:0;overflow:auto;transition:max-height var(--speed)}
    .dock.expanded .content{max-height:80vh;padding:10px}
    .dock .bar{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px;border-top:1px solid var(--border)}
    .dock .bar button{flex:1}

    /* Dock panels */
    .panel{display:none}
    .panel.active{display:block}

    /* Chat list */
    .list{display:flex;flex-direction:column;gap:8px}
    .item{display:flex;gap:10px;align-items:center;padding:8px;border:1px solid var(--border);border-radius:12px;background:var(--bg)}
    .item .name{font-weight:600}

    /* Chat window */
    .chat{display:flex;flex-direction:column;height:60vh}
    .chat .messages{flex:1;overflow:auto;display:flex;flex-direction:column;gap:6px;padding:6px;border:1px solid var(--border);border-radius:12px;background:var(--bg)}
    .bubble{max-width:75%;padding:8px 10px;border-radius:14px;border:1px solid var(--border);background:var(--card)}
    .bubble.me{align-self:flex-end;background:var(--primary);border-color:transparent;color:#fff}
    .chat .composer{display:flex;gap:8px;margin-top:8px}
    .chat .composer input{flex:1}

    /* Toast */
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:80px;background:var(--card);border:1px solid var(--border);padding:.6rem 1rem;border-radius:14px;box-shadow:var(--elev);opacity:0;pointer-events:none;transition:opacity var(--speed),transform var(--speed);z-index:50}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}

    /* Settings */
    .themes{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .swatch{border-radius:14px;padding:10px;border:1px solid var(--border);display:grid;gap:8px}
    .swatch .colors{display:flex;gap:6px}
    .dot{width:18px;height:18px;border-radius:50%}

    /* Responsive */
    @media (max-width:520px){ .dock{width:92%} header.appbar h1{font-size:16px} }
  </style>
</head>
<body>
  <!-- AUTH VIEW -->
  <section id="authView">
    <div class="auth-box card" style="padding:16px">
      <div class="auth-head">
        <div class="logo"></div>
        <div>
          <div style="font-weight:800;font-size:18px">xlifer</div>
          <div class="hint">Prijava ali registracija</div>
        </div>
      </div>

      <div id="loginStepEmail" class="stack">
        <label for="loginEmail">E-mail</label>
        <input id="loginEmail" type="email" placeholder="tvoj@email.si" autocomplete="username" />
        <div class="row">
          <button id="btnCheckEmail" class="primary" title="Prijava">Prijava</button>
          <button id="btnStartRegister">Registracija</button>
          <button id="btnForgot" class="ghost">Pozabil/-a sem geslo</button>
        </div>
        <div class="hint" id="emailStatus"></div>
      </div>

      <div id="loginStepPassword" class="stack hide">
        <label for="loginPassword">Geslo</label>
        <input id="loginPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
        <div class="row">
          <button id="btnDoLogin" class="primary">Prijava</button>
          <button id="btnBackToEmail" class="ghost">Nazaj</button>
        </div>
        <div class="hint" id="passStatus"></div>
      </div>

      <div id="registerBox" class="stack hide">
        <div style="font-weight:700">Ustvari raƒçun</div>
        <label>Ime</label>
        <input id="regName" placeholder="Tvoje ime" />
        <label>Profilna slika (jpeg/png)</label>
        <input id="regPhoto" type="file" accept="image/*" />
        <label>E-mail</label>
        <input id="regEmail" type="email" placeholder="tvoj@email.si" autocomplete="email" />
        <label>Geslo</label>
        <input id="regPass1" type="password" autocomplete="new-password" />
        <label>Ponovi geslo</label>
        <input id="regPass2" type="password" autocomplete="new-password" />
        <div class="row">
          <button id="btnDoRegister" class="primary">Ustvari</button>
          <button id="btnCancelRegister" class="ghost">Prekliƒçi</button>
        </div>
        <div class="hint" id="regStatus"></div>
      </div>
    </div>
  </section>

  <!-- APP VIEW -->
  <header class="appbar hide" id="appbar">
    <h1>xlifer</h1>
    <div class="spacer"></div>
    <div id="whoami" class="hint"></div>
  </header>

  <main id="app" class="hide">
    <!-- Stories -->
    <section class="card" style="padding:10px">
      <div class="stories" id="stories"></div>
    </section>

    <!-- Feed -->
    <section class="feed" id="feed"></section>
  </main>

  <!-- Bottom Dock (CONTENT ABOVE THE BUTTONS) -->
  <div class="dock collapsed" id="dock">
    <div class="handle"><span></span></div>

    <div class="content">
      <!-- Panels -->
      <div class="panel" id="panelChat">
        <div id="chatList" class="list"></div>
        <div id="chatWindow" class="chat hide">
          <div class="row" style="justify-content:space-between;margin-bottom:6px">
            <div><strong id="chatTitle">Chat</strong></div>
            <div class="hint" id="chatHint"></div>
          </div>
          <div class="messages" id="messages"></div>
        </div>
      </div>

      <div class="panel" id="panelSearch">
        <div class="row" style="gap:8px">
          <button id="btnCloseSearch">‚úñ</button>
          <input id="searchInput" placeholder="I≈°ƒçi uporabnike (v ≈æivo)‚Ä¶" />
          <button id="btnWhoAddedMe">Kdo je dodal mene?</button>
        </div>
        <div id="searchResults" class="list" style="margin-top:10px"></div>
        <div id="profilePreview" class="card hide" style="padding:10px;margin-top:10px"></div>
      </div>

      <div class="panel" id="panelProfile">
        <div class="row" style="gap:8px">
          <button id="btnCloseProfile">‚úñ</button>
          <button id="btnEditProfile">Uredi</button>
          <button id="btnTogglePublic">Javno/Zasebno</button>
        </div>
        <div id="myProfile" class="stack" style="margin-top:10px"></div>
        <div id="editProfile" class="card hide" style="padding:10px;margin-top:10px">
          <div class="stack">
            <label>Ime</label><input id="epName" />
            <label>Slika</label><input id="epPhoto" type="file" accept="image/*" />
            <label>Opis</label><textarea id="epBio" rows="3"></textarea>
            <div class="row">
              <div class="stack" style="flex:1">
                <label>Rojstvo</label><input id="epBirthday" type="date" />
                <select id="visBirthday"><option value="public">Javno</option><option value="friends">Prijatelji</option><option value="private">Zasebno</option></select>
              </div>
              <div class="stack" style="flex:1">
                <label>Kraj</label><input id="epCity" />
                <select id="visCity"><option value="public">Javno</option><option value="friends">Prijatelji</option><option value="private">Zasebno</option></select>
              </div>
              <div class="stack" style="flex:1">
                <label>Razmerje</label><input id="epRel" />
                <select id="visRel"><option value="public">Javno</option><option value="friends">Prijatelji</option><option value="private">Zasebno</option></select>
              </div>
            </div>
            <div class="row">
              <button id="btnSaveProfile" class="primary">Shrani</button>
              <button id="btnCancelEdit" class="ghost">Prekliƒçi</button>
            </div>
          </div>
        </div>
      </div>

      <div class="panel" id="panelSettings">
        <div class="row" style="gap:8px;align-items:center">
          <button id="btnCloseSettings">‚úñ</button>
          <div style="font-weight:700">Nastavitve</div>
        </div>
        <div style="margin-top:10px" class="stack">
          <div style="font-weight:700">Tema</div>
          <div class="themes">
            <div class="swatch" data-theme-pick="breeze">
              <div><strong>Breeze</strong></div>
              <div class="colors"><div class="dot" style="background:#F7F8FA;border:1px solid #E5E7EB"></div><div class="dot" style="background:#2563EB"></div><div class="dot" style="background:#22C55E"></div></div>
            </div>
            <div class="swatch" data-theme-pick="midnight">
              <div><strong>Midnight</strong></div>
              <div class="colors"><div class="dot" style="background:#0B1020"></div><div class="dot" style="background:#60A5FA"></div><div class="dot" style="background:#34D399"></div></div>
            </div>
            <div class="swatch" data-theme-pick="obsidian">
              <div><strong>Obsidian</strong></div>
              <div class="colors"><div class="dot" style="background:#000"></div><div class="dot" style="background:#4F46E5"></div><div class="dot" style="background:#10B981"></div></div>
            </div>
            <div class="swatch" data-theme-pick="sunset">
              <div><strong>Sunset</strong></div>
              <div class="colors"><div class="dot" style="background:#1B0E0A"></div><div class="dot" style="background:#FB923C"></div><div class="dot" style="background:#F59E0B"></div></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- BARS AT THE BOTTOM OF THE DOCK -->
    <div class="bar" id="dockBarDefault">
      <button data-action="chat">üí¨ Chat</button>
      <button data-action="search">üîé Iskalnik</button>
      <button data-action="profile">üë§ Profil</button>
      <button data-action="settings">‚öôÔ∏è Nastavitve</button>
    </div>

    <div class="bar hide" id="dockBarChat">
      <button data-action="close">‚úñ</button>
      <button data-action="add-group">‚ûï Skupina</button>
      <button data-action="autoseen">‚ñ∂Ô∏è Autoseen</button>
      <button data-action="notif-toggle">üîî Obvestila</button>
    </div>

    <div class="bar hide" id="dockBarChatOpen" style="gap:8px">
      <button data-action="back">‚¨Ö</button>
      <input id="chatInput" placeholder="Napi≈°i sporoƒçilo‚Ä¶ (Enter=po≈°lji)" />
      <button id="btnSend">Po≈°lji</button>
      <button id="btnAddImage" class="hide">üñºÔ∏è</button>
      <input type="file" id="chatImagePicker" accept="image/*" class="hide" />
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Firebase SDKs (REAL DATA ONLY; no mock seed) -->
  <script type="module">
    // ======== FIREBASE BOOTSTRAP ========
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, fetchSignInMethodsForEmail, sendPasswordResetEmail, createUserWithEmailAndPassword, updateProfile, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp, collection, addDoc, query, where, orderBy, limit, onSnapshot, startAt, endAt } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
    import { getStorage, ref, uploadString, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ======== DOM HELPERS ========
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const show = (el, yes=true)=> el.classList.toggle('hide', !yes);
    const toast = (msg)=>{ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 5000); };

    // ======== THEME ========
    const applyTheme = (name)=>{ document.documentElement.setAttribute('data-theme', name); localStorage.setItem('xlifer_theme', name); };
    (function(){ const t = localStorage.getItem('xlifer_theme') || 'breeze'; applyTheme(t); })();
    $$('#panelSettings .swatch').forEach(sw=> sw.addEventListener('click', async ()=>{
      const theme = sw.getAttribute('data-theme-pick');
      applyTheme(theme);
      if(auth.currentUser){ await setDoc(doc(db, 'users', auth.currentUser.uid), { settings:{ theme } }, { merge:true }); }
    }));

    // ======== AUTH FLOW (progressive) ========
    const authView = $('#authView');
    const appbar = $('#appbar');
    const appMain = $('#app');
    const whoami = $('#whoami');

    const loginEmail = $('#loginEmail');
    const btnCheckEmail = $('#btnCheckEmail');
    const emailStatus = $('#emailStatus');
    const loginStepPassword = $('#loginStepPassword');
    const loginStepEmail = $('#loginStepEmail');
    const loginPassword = $('#loginPassword');
    const btnDoLogin = $('#btnDoLogin');
    const btnBackToEmail = $('#btnBackToEmail');

    const btnForgot = $('#btnForgot');
    const btnStartRegister = $('#btnStartRegister');

    const regBox = $('#registerBox');
    const regName = $('#regName');
    const regPhoto = $('#regPhoto');
    const regEmail = $('#regEmail');
    const regPass1 = $('#regPass1');
    const regPass2 = $('#regPass2');
    const regStatus = $('#regStatus');
    const btnDoRegister = $('#btnDoRegister');
    const btnCancelRegister = $('#btnCancelRegister');

    btnCheckEmail.addEventListener('click', async ()=>{
      const email = loginEmail.value.trim();
      if(!email){ emailStatus.textContent='Vnesi e-mail.'; return; }
      emailStatus.textContent='Preverjam‚Ä¶';
      const methods = await fetchSignInMethodsForEmail(auth, email);
      if(methods.includes('password')){
        emailStatus.textContent='Najden raƒçun. Vnesi geslo.';
        show(loginStepEmail,false); show(loginStepPassword,true); loginPassword.focus();
      }else{ emailStatus.textContent='Ta e-mail ≈°e ni registriran. Ustvari raƒçun?'; }
    });

    btnBackToEmail.addEventListener('click', ()=>{ show(loginStepPassword,false); show(loginStepEmail,true); });

    btnDoLogin.addEventListener('click', async ()=>{
      const email = loginEmail.value.trim();
      const pass = loginPassword.value;
      try{ await signInWithEmailAndPassword(auth, email, pass); }catch(e){ $('#passStatus').textContent = 'Napaƒçno geslo ali napaka.'; }
    });

    btnForgot.addEventListener('click', async ()=>{
      const email = loginEmail.value.trim();
      if(!email){ emailStatus.textContent='Vnesi e-mail za ponastavitev.'; return }
      await sendPasswordResetEmail(auth, email);
      toast('ƒåe e-mail obstaja, smo poslali navodila.');
    });

    btnStartRegister.addEventListener('click', ()=>{ show(loginStepEmail,false); show(regBox,true); });
    btnCancelRegister.addEventListener('click', ()=>{ show(regBox,false); show(loginStepEmail,true); });

    btnDoRegister.addEventListener('click', async ()=>{
      const name = regName.value.trim();
      const email = regEmail.value.trim();
      const p1 = regPass1.value; const p2 = regPass2.value;
      if(!name||!email||!p1){ regStatus.textContent='Izpolni vsa polja.'; return; }
      if(p1!==p2){ regStatus.textContent='Gesli se ne ujemata.'; return; }
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, p1);
        await updateProfile(cred.user, { displayName:name });
        let photoURL = '';
        if(regPhoto.files[0]){
          const b64 = await fileToBase64(regPhoto.files[0]);
          const r = ref(storage, `pfp/${cred.user.uid}.txt`); // base64 as text
          await uploadString(r, b64, 'raw');
          photoURL = await getDownloadURL(r);
        }
        await setDoc(doc(db,'users',cred.user.uid),{
          displayName:name, photoURL:photoURL||'', createdAt: serverTimestamp(), isPublic:true,
          about:{}, visibility:{ birthday:'friends', city:'public', relationship:'private' },
          displayName_lc: name.toLowerCase(), settings:{ theme: document.documentElement.getAttribute('data-theme') }
        });
      }catch(e){ regStatus.textContent='Napaka pri registraciji.'; console.error(e); }
    });

    onAuthStateChanged(auth, async (user)=>{
      if(user){ enterApp(user); } else { show(authView,true); show(appbar,false); show(appMain,false); }
    });

    async function enterApp(user){
      show(authView,false); show(appbar,true); show(appMain,true);
      whoami.textContent = user.displayName? `Pozdravljen/-a, ${user.displayName}` : 'Prijavljen';
      // load theme preference
      try{ const snap = await getDoc(doc(db,'users',user.uid)); const data = snap.data(); if(data?.settings?.theme){ applyTheme(data.settings.theme); } }catch{}
      subscribeStoriesAndFeed();
    }

    // ======== FEED & STORIES (FIREBASE ONLY) ========
    function subscribeStoriesAndFeed(){
      const storiesEl = $('#stories'); storiesEl.innerHTML = '';
      // stories (not filtered by friends for simplicity; add friend-based filter later)
      const qStories = query(collection(db,'stories'), where('expiresAt','>', new Date()), orderBy('expiresAt','desc'), limit(30));
      onSnapshot(qStories, (snap)=>{
        storiesEl.innerHTML='';
        snap.forEach(docu=>{
          const s = docu.data();
          const el = document.createElement('div'); el.className='story';
          el.innerHTML = `<div class="circle"><div class="inner">${s.base64?`<img alt="" src="${s.base64}"/>`:''}</div></div><div class="name">${s.authorName||'Uporabnik'}</div>`;
          storiesEl.appendChild(el);
        });
      });

      const feedEl = $('#feed'); feedEl.innerHTML = '';
      const qFeed = query(collection(db,'posts'), where('visibility','==','public'), orderBy('createdAt','desc'), limit(30));
      onSnapshot(qFeed, (snap)=>{
        feedEl.innerHTML='';
        snap.forEach(docu=>{
          const p = docu.data();
          const el = document.createElement('article'); el.className='post card';
          el.innerHTML = `
            <div class="head">
              <div class="avatar">${p.authorPhoto?`<img src="${p.authorPhoto}" alt=""/>`:''}</div>
              <div>
                <div style="font-weight:700">${p.authorName||'Uporabnik'}</div>
                <div class="meta">${(p.createdAt?.toDate?.()||new Date()).toLocaleString()}</div>
              </div>
            </div>
            ${p.base64?`<div class="media"><img src="${p.base64}" alt=""/></div>`:''}
            ${p.caption?`<div style="margin-top:6px">${p.caption}</div>`:''}
            <div class="actions">
              <button data-like="${docu.id}">‚ù§Ô∏è V≈°eƒç mi je</button>
              <button data-comment="${docu.id}">üí¨ Komentiraj</button>
              <button data-share="${docu.id}">üì§ Po≈°lji v chat</button>
            </div>`;
          feedEl.appendChild(el);
        });
      });
    }

    // ======== DOCK STATE MACHINE ========
    const dock = $('#dock');
    const dockBarDefault = $('#dockBarDefault');
    const dockBarChat = $('#dockBarChat');
    const dockBarChatOpen = $('#dockBarChatOpen');
    const panels = { chat: $('#panelChat'), search: $('#panelSearch'), profile: $('#panelProfile'), settings: $('#panelSettings') };

    dock.addEventListener('click', (e)=>{ if(e.target.closest('.handle')){ toggleDock(); } });
    dockBarDefault.addEventListener('click', (e)=>{ const action = e.target.getAttribute('data-action'); if(!action) return; openDock(action); });
    dockBarChat.addEventListener('click', (e)=>{
      const action = e.target.getAttribute('data-action'); if(!action) return;
      if(action==='close') return collapseDock();
      if(action==='add-group') return createGroupFlow();
      if(action==='autoseen') return runAutoseen();
      if(action==='notif-toggle') return toggleNotifications();
    });

    $('#btnCloseSearch').addEventListener('click', collapseDock);
    $('#btnCloseProfile').addEventListener('click', collapseDock);
    $('#btnCloseSettings').addEventListener('click', collapseDock);

    function toggleDock(){ dock.classList.toggle('expanded'); dock.classList.toggle('collapsed'); }
    function expandDock(){ dock.classList.add('expanded'); dock.classList.remove('collapsed'); }
    function collapseDock(){ dock.classList.add('collapsed'); dock.classList.remove('expanded'); resetDockBars(); hidePanels(); }
    function resetDockBars(){ show(dockBarDefault,true); show(dockBarChat,false); show(dockBarChatOpen,false); }
    function hidePanels(){ Object.values(panels).forEach(p=>p.classList.remove('active')); }

    function openDock(panel){
      expandDock(); hidePanels(); resetDockBars();
      if(panel==='chat'){ panels.chat.classList.add('active'); show(dockBarDefault,false); show(dockBarChat,true); renderChatList(); }
      else if(panel==='search'){ panels.search.classList.add('active'); }
      else if(panel==='profile'){ panels.profile.classList.add('active'); renderMyProfile(); }
      else if(panel==='settings'){ panels.settings.classList.add('active'); }
    }

    // ======== CHAT (FIREBASE, no mock) ========
    const chatListEl = $('#chatList');
    const chatWindow = $('#chatWindow');
    const messagesEl = $('#messages');
    const chatTitle = $('#chatTitle');
    const chatHint = $('#chatHint');
    const chatInput = $('#chatInput');
    const btnSend = $('#btnSend');
    const btnAddImage = $('#btnAddImage');
    const chatImagePicker = $('#chatImagePicker');

    let unsubConvos = null; let unsubMsgs = null; let currentConvId = null; let pendingImageB64 = null;

    function renderChatList(){
      show(chatWindow,false); chatListEl.innerHTML='<div class="hint">Nalagam pogovore‚Ä¶</div>';
      if(unsubConvos) unsubConvos();
      const qConvos = query(collection(db,'conversations'), where('members','array-contains', auth.currentUser.uid), orderBy('lastMessageAt','desc'), limit(50));
      unsubConvos = onSnapshot(qConvos, (snap)=>{
        chatListEl.innerHTML='';
        if(snap.empty){ chatListEl.innerHTML = '<div class="hint">Ni pogovorov. Ustvari skupino ali zaƒçni nov chat.</div>'; }
        snap.forEach(docu=>{
          const c = docu.data();
          const el = document.createElement('div'); el.className='item';
          const name = c.type==='group' ? (c.title||'Skupina') : (c.memberNames?.find(m=>m.uid!==auth.currentUser.uid)?.name || 'Chat');
          el.innerHTML = `<div class="avatar"></div><div class="name">${name}</div><div class="spacer"></div><div class="hint">${c.lastMessageAt? new Date(c.lastMessageAt.seconds*1000).toLocaleTimeString(): ''}</div>`;
          el.addEventListener('click', ()=> openChat(docu.id, name));
          chatListEl.appendChild(el);
        });
      });
    }

    function openChat(convId, title){
      currentConvId = convId; chatTitle.textContent = title||'Chat'; chatHint.textContent = '';
      messagesEl.innerHTML=''; show(chatWindow,true); show(dockBarChat,false); show(dockBarChatOpen,true);
      if(unsubMsgs) unsubMsgs();
      const qMsgs = query(collection(db,'conversations',convId,'messages'), orderBy('createdAt','asc'), limit(500));
      unsubMsgs = onSnapshot(qMsgs, (snap)=>{
        messagesEl.innerHTML='';
        snap.forEach(docu=>{
          const m = docu.data();
          const b = document.createElement('div'); b.className='bubble'+(m.authorId===auth.currentUser.uid?' me':'');
          b.textContent = m.text || (m.base64? '[slika]':'');
          if(m.base64 && !m.text){ b.innerHTML = `<img src="${m.base64}" alt="slika" style="max-width:100%"/>`; }
          messagesEl.appendChild(b);
        });
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    }

    chatInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); quickSend(); } });
    function updateSendButtons(){ const empty = !chatInput.value.trim() && !pendingImageB64; show(btnAddImage, empty); show(btnSend, !empty); }
    chatInput.addEventListener('input', updateSendButtons);
    $('#dockBarChatOpen').addEventListener('click', (e)=>{ if(e.target.getAttribute('data-action')==='back'){ show(dockBarChatOpen,false); show(dockBarChat,true); show(chatWindow,false); if(unsubMsgs){unsubMsgs(); unsubMsgs=null;} } });
    $('#btnAddImage').addEventListener('click', ()=> chatImagePicker.click());
    chatImagePicker.addEventListener('change', async ()=>{ const f = chatImagePicker.files[0]; if(!f) return; pendingImageB64 = await fileToBase64(f); updateSendButtons(); toast('Slika pripravljena za po≈°iljanje.'); });
    btnSend.addEventListener('click', sendWithOptions);

    async function quickSend(){ if(!currentConvId) return; const txt = chatInput.value.trim(); if(!txt && !pendingImageB64) return; await pushMessage({ text: txt||'', base64: pendingImageB64||null }); chatInput.value=''; pendingImageB64=null; updateSendButtons(); }

    async function sendWithOptions(){ if(!currentConvId) return; if(!chatInput.value.trim() && !pendingImageB64) return; const choice = window.prompt('Po≈°iljanje: vpi≈°i "now" (takoj), "schedule:YYYY-MM-DD HH:MM" ali "temp:minutes"', 'now'); if(!choice) return; if(choice.startsWith('schedule:')){ const when = choice.replace('schedule:',''); await pushMessage({ text: chatInput.value.trim(), base64: pendingImageB64||null, scheduledFor: when }); } else if(choice.startsWith('temp:')){ const mins = parseInt(choice.replace('temp:',''),10)||10; const expiresAt = Date.now() + mins*60000; await pushMessage({ text: chatInput.value.trim(), base64: pendingImageB64||null, expiresAt }); } else { await quickSend(); } }

    async function pushMessage({text='', base64=null, scheduledFor=null, expiresAt=null}){
      const convRef = doc(db,'conversations', currentConvId);
      await addDoc(collection(convRef,'messages'), { authorId: auth.currentUser.uid, text, base64, createdAt: serverTimestamp(), scheduledFor: scheduledFor||null, expiresAt: expiresAt||null });
      await updateDoc(convRef, { lastMessageAt: serverTimestamp() });
    }

    function createGroupFlow(){ toast('Izberi prijatelje (implementiraj v iskalniku)'); }
    function runAutoseen(){ toast('Autoseen bo ≈°el po pogovorih z neprebranimi (TODO: per-user read markers).'); }
    function toggleNotifications(){ toast('Preklop obvestil (FCM) ‚Äì TODO'); }

    // ======== SEARCH (FIREBASE) ========
    const searchInput = $('#searchInput');
    const searchResults = $('#searchResults');
    const profilePreview = $('#profilePreview');

    searchInput.addEventListener('input', ()=>{
      const qtxt = searchInput.value.trim().toLowerCase();
      if(!qtxt){ searchResults.innerHTML=''; show(profilePreview,false); return; }
      const qUsers = query(collection(db,'users'), orderBy('displayName_lc'), startAt(qtxt), endAt(qtxt+'Ô£ø'), limit(20));
      onSnapshot(qUsers, (snap)=>{
        searchResults.innerHTML=''; show(profilePreview,false);
        snap.forEach(docu=>{
          const u = docu.data();
          const el = document.createElement('div'); el.className='item';
          el.innerHTML = `<div class="avatar">${u.photoURL?`<img src="${u.photoURL}"/>`:''}</div><div class="name">${u.displayName||'Uporabnik'}</div>`;
          el.addEventListener('click', ()=> showProfilePreview(docu.id, u));
          searchResults.appendChild(el);
        });
      });
    });

    $('#btnWhoAddedMe').addEventListener('click', ()=>{ toast('Seznam uporabnikov, ki so te dodali (TODO: friendships).'); });

    function showProfilePreview(uid, user){
      profilePreview.innerHTML = `
        <div class="row" style="align-items:center;gap:10px">
          <div class="avatar">${user.photoURL?`<img src="${user.photoURL}"/>`:''}</div>
          <div style="flex:1"><div style="font-weight:700">${user.displayName||'Uporabnik'}</div><div class="hint">${user.bio||''}</div></div>
          <button id="btnAddFriend">Dodaj</button>
        </div>
        <div class="divider"></div>
        <div class="stack"><div style="opacity:.7">Objave</div><div class="row"><div class="card" style="width:100px;height:80px"></div><div class="card" style="width:100px;height:80px"></div><div class="card" style="width:100px;height:80px"></div></div></div>`;
      show(profilePreview,true);
      profilePreview.querySelector('#btnAddFriend').addEventListener('click', async ()=>{ toast(`Poslana pro≈°nja za prijateljstvo: ${user.displayName||uid}`); /* TODO friendships */ });
    }

    // ======== PROFILE ========
    const myProfile = $('#myProfile');
    const editProfile = $('#editProfile');
    $('#btnEditProfile').addEventListener('click', ()=>{ show(editProfile,true); fillEditProfile(); });
    $('#btnCancelEdit').addEventListener('click', ()=>{ show(editProfile,false); });
    $('#btnTogglePublic').addEventListener('click', async ()=>{ const uref = doc(db,'users',auth.currentUser.uid); const snap = await getDoc(uref); const cur = !!snap.data()?.isPublic; await updateDoc(uref,{ isPublic: !cur }); toast(`Profil ${!cur? 'javno':'zasebno'}`); renderMyProfile(); });
    $('#btnSaveProfile').addEventListener('click', async ()=>{
      const name = $('#epName').value.trim();
      const bio = $('#epBio').value.trim();
      const birthday = $('#epBirthday').value||null;
      const city = $('#epCity').value.trim();
      const rel = $('#epRel').value.trim();
      const vis = { birthday: $('#visBirthday').value, city: $('#visCity').value, relationship: $('#visRel').value };
      let photoURL = null;
      const file = $('#epPhoto').files[0];
      if(file){ const b64 = await fileToBase64(file); const r = ref(storage, `pfp/${auth.currentUser.uid}.txt`); await uploadString(r, b64, 'raw'); photoURL = await getDownloadURL(r); }
      await setDoc(doc(db,'users',auth.currentUser.uid), {
        displayName: name || auth.currentUser.displayName || '', bio, about:{birthday, city, relationship:rel}, visibility: vis,
        ...(photoURL? { photoURL } : {})
      }, { merge:true });
      toast('Profil shranjen.'); show(editProfile,false); renderMyProfile();
    });

    async function renderMyProfile(){
      const snap = await getDoc(doc(db,'users',auth.currentUser.uid));
      const u = snap.data()||{};
      myProfile.innerHTML = `
        <div class="row" style="align-items:center;gap:10px">
          <div class="avatar">${u.photoURL?`<img src="${u.photoURL}" alt=""/>`:''}</div>
          <div>
            <div style="font-weight:800">${u.displayName||'Moj profil'}</div>
            <div class="hint">Status: ${u.isPublic? 'javno':'zasebno'}</div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="stack">
          <div><strong>Opis</strong><div class="hint">${u.bio||'‚Äî'}</div></div>
          <div class="row" style="gap:10px">
            <div class="card" style="flex:1;padding:10px"><div class="hint">Rojstvo</div>${u?.about?.birthday||'‚Äî'}</div>
            <div class="card" style="flex:1;padding:10px"><div class="hint">Kraj</div>${u?.about?.city||'‚Äî'}</div>
            <div class="card" style="flex:1;padding:10px"><div class="hint">Razmerje</div>${u?.about?.relationship||'‚Äî'}</div>
          </div>
        </div>`;
    }

    async function fillEditProfile(){
      const snap = await getDoc(doc(db,'users',auth.currentUser.uid));
      const u = snap.data()||{};
      $('#epName').value = u.displayName||'';
      $('#epBio').value = u.bio||'';
      $('#epBirthday').value = u?.about?.birthday||'';
      $('#epCity').value = u?.about?.city||'';
      $('#epRel').value = u?.about?.relationship||'';
      $('#visBirthday').value = u?.visibility?.birthday||'friends';
      $('#visCity').value = u?.visibility?.city||'public';
      $('#visRel').value = u?.visibility?.relationship||'private';
    }

    // ======== UTIL ========
    function fileToBase64(file){ return new Promise((res,rej)=>{ const r = new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
  </script>
</body>
</html>
