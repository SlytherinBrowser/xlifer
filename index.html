<!doctype html>
<html lang="sl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini Snapchat ‚Äì prijatelji, chat in zemljevid</title>

<!-- Leaflet 1.9.4 (CSS) z integriteto -->
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>

<style>
  :root{
    --dock-bg:#111827; --dock-fg:#e5e7eb;
    --ring:#334155; --ok:#22c55e; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#0b1020;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}

  /* App layout */
  #app{position:fixed; inset:0; display:none;}
  #map{
    position:absolute; inset:0;
    height:100%; min-height:100%;
    z-index:0;
  }

  .emoji-label{background:rgba(17,24,39,.9);color:#e5e7eb;padding:2px 6px;border-radius:12px;font-size:12px;margin-top:2px;white-space:nowrap}

  /* Dock */
  #dock{position:fixed; left:0; right:0; bottom:0; z-index:10;
    background:var(--dock-bg); color:var(--dock-fg);
    border-top:1px solid #1f2937; display:flex; flex-direction:column;
    box-shadow:0 -10px 30px rgba(0,0,0,.35); max-height:85vh; height:72px; transition:height .2s ease;
  }
  .dock-buttons{display:flex; gap:10px; justify-content:space-around; padding:10px 12px; border-top:1px solid #1f2937; background:#0f172a}
  .dock-toolbar{display:none; grid-template-columns:1fr auto 1fr; gap:10px; align-items:center; padding:8px 12px; border-top:1px solid #1f2937; background:#0f172a}
  .dock-content{display:none; padding:12px 14px 10px; overflow:auto}

  button{appearance:none; border:1px solid #1f2937; background:#0b1222; color:#e5e7eb; padding:10px 12px; border-radius:10px; font-weight:600; cursor:pointer; transition:transform .05s, background .2s}
  button:hover{background:#111a2e} button:active{transform:translateY(1px)}
  .btn-primary{background:linear-gradient(180deg,#22c55e,#16a34a); border-color:#15803d}
  .btn-ghost{background:transparent; border-color:#334155}
  .btn-danger{background:linear-gradient(180deg,#ef4444,#dc2626); border-color:#b91c1c}

  input,textarea{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--ring); background:#0b1222; color:#e5e7eb; outline:none}

  .list{display:flex; flex-direction:column; gap:8px}
  .item{background:#0f172a; border:1px solid #273244; border-radius:12px; padding:10px 12px; display:flex; align-items:center; gap:10px; justify-content:space-between}
  .item .left{display:flex; align-items:center; gap:10px}
  .avatar{width:36px; height:36px; border-radius:10px; display:grid; place-items:center; background:#0b1222; border:1px solid #273244; font-size:20px}
  .muted{color:#94a3b8; font-size:12px}

  .chat-header{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px}
  .chat-box{background:#0f172a; border:1px solid #273244; border-radius:12px; padding:10px; height:40vh; overflow:auto; display:flex; flex-direction:column; gap:6px}
  .msg{max-width:80%; padding:8px 10px; border-radius:12px}
  .me{align-self:flex-end; background:#1c3a2b}
  .them{align-self:flex-start; background:#13213c}
  .msg .time{font-size:10px; color:#94a3b8; margin-top:2px}

  #auth{position:fixed; inset:0; display:grid; place-items:center; padding:20px}
  .panel{width:min(560px,96vw); background:#0b1222; border:1px solid #1f2937; border-radius:16px; padding:20px; box-shadow:0 20px 60px rgba(0,0,0,.45)}
  .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .divider{height:1px; background:#1f2937; margin:14px 0}

  #toast{position:fixed; left:50%; transform:translateX(-50%); bottom:92px; background:#0b1222; border:1px solid #273244; border-radius:12px; padding:10px 14px; display:none; box-shadow:0 10px 30px rgba(0,0,0,.35); z-index:1000}
  .hidden{display:none !important}

  /* inline banner ‚Äì lokacija */
  #locBanner{position:fixed; left:50%; transform:translateX(-50%); top:10px; background:#0b1222; border:1px dashed #334155; border-radius:12px; padding:10px 14px; z-index:1000; display:none}
</style>
</head>
<body>

<!-- AUTH -->
<section id="auth">
  <div class="panel">
    <h1>Prijava</h1>
    <div class="grid-2">
      <div><label>E-po≈°ta</label><input id="loginEmail" type="email" placeholder="ime@domena.si" /></div>
      <div><label>Geslo</label><input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
    </div>
    <div class="grid-2" style="margin-top:10px;">
      <button id="btnLogin" class="btn-primary">Prijavi me</button>
      <button id="btnAnon" class="btn-ghost" title="Hiter preizkus">Gost (demo)</button>
    </div>

    <div class="divider"></div>

    <h1>Registracija</h1>
    <div class="grid-2">
      <div><label>Ime</label><input id="regName" placeholder="Tvoje ime" /></div>
      <div><label>Rojstni datum</label><input id="regDob" type="date" /></div>
      <div><label>E-po≈°ta</label><input id="regEmail" type="email" placeholder="ime@domena.si" /></div>
      <div><label>Geslo</label><input id="regPass" type="password" placeholder="vsaj 6 znakov" /></div>
    </div>
    <div style="margin-top:10px;"><button id="btnRegister" class="btn-primary" style="width:100%;">Ustvari raƒçun</button></div>
  </div>
</section>

<!-- APP -->
<section id="app">
  <div id="map"></div>

  <!-- Lokacijski banner -->
  <div id="locBanner">
    Za prikaz tvoje lokacije dovoli dostop.
    <button id="btnAskLoc" class="btn-primary" style="margin-left:8px;">Dovoli lokacijo</button>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <!-- Dock -->
  <div id="dock">
    <div id="dockContent" class="dock-content"></div>

    <div id="searchToolbar" class="dock-toolbar">
      <button id="btnCloseSearch" class="btn-ghost">Zapri</button>
      <input id="searchInput" placeholder="I≈°ƒçi uporabnike po imenu ali e-po≈°ti‚Ä¶" />
      <button id="btnWhoAddedMe" class="btn-ghost">Kdo me je dodal</button>
    </div>

    <div id="chatComposer" class="dock-toolbar">
      <input id="chatInput" placeholder="Napi≈°i sporoƒçilo‚Ä¶" />
      <button id="btnSend" class="btn-primary">Po≈°lji</button>
    </div>

    <div class="dock-buttons">
      <button id="btnFriends">üë• Prijatelji</button>
      <button id="btnSearch">üîé Iskanje</button>
      <button id="btnProfile">üë§ Moj profil</button>
    </div>
  </div>
</section>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Leaflet 1.9.4 (JS) z integriteto -->
<script
  src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin="">
</script>

<script>
/*** Firebase INIT ***/

const firebaseConfig = {
  apiKey: "AIzaSyAhA1s2iiJDMMeqoOrp1asJO1eha_R0ivg",
  authDomain: "slychat1-b76db.firebaseapp.com",
  databaseURL: "https://slychat1-b76db-default-rtdb.firebaseio.com",
  projectId: "slychat1-b76db",
  storageBucket: "slychat1-b76db.firebasestorage.app",
  messagingSenderId: "508879069664",
  appId: "1:508879069664:web:ce963d111297cd3480cb85",
  measurementId: "G-D34XJNNGNQ"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/*** State ***/
const state = {
  me:null, view:null, chatWith:null,
  unsub:{ friends:null, chat:null, inbox:null, users:null },
  map:null, markers:new Map(),
  dockMode:'shrunk', // 'shrunk' | 'expanded'
  locWatchId:null
};

/*** Shortcuts ***/
const $ = s => document.querySelector(s);
const el = (t,c,h)=>{const n=document.createElement(t); if(c) n.className=c; if(h!==undefined) n.innerHTML=h; return n;};
const esc = s => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;');

/*** Toast / banners ***/
function toast(msg,ms=3500){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',ms); }
function showLocBanner(show){ $('#locBanner').style.display = show ? 'block' : 'none'; }

/*** Dock sizing ***/
function setDockShrunk(){
  state.dockMode='shrunk';
  $('#dockContent').style.display='none';
  $('#searchToolbar').style.display='none';
  $('#chatComposer').style.display='none';
  $('#dock').style.height='72px';
  invalidateMapSoon();
}
function setDockExpanded({search=false, chat=false}={}){
  state.dockMode='expanded';
  $('#dockContent').style.display='block';
  $('#searchToolbar').style.display = search ? 'grid' : 'none';
  $('#chatComposer').style.display  = chat   ? 'grid' : 'none';
  adjustDockHeight();
}
function adjustDockHeight(){
  const baseH = 52; // buttons
  const contentH = $('#dockContent').offsetHeight||0;
  const searchH = $('#searchToolbar').style.display!=='none' ? $('#searchToolbar').offsetHeight : 0;
  const chatH = $('#chatComposer').style.display!=='none' ? $('#chatComposer').offsetHeight : 0;
  const padding = 28;
  let target = contentH + searchH + chatH + baseH + padding;
  const max = Math.floor(window.innerHeight*0.85);
  target = Math.max(240, Math.min(target, max));
  $('#dock').style.height = target+'px';
  const contentAvail = target - (searchH + chatH + baseH + padding);
  $('#dockContent').style.maxHeight = Math.max(120, contentAvail) +'px';
  invalidateMapSoon();
}
const ro = new ResizeObserver(()=>{ if(state.dockMode==='expanded') adjustDockHeight(); });
ro.observe($('#dockContent'));
window.addEventListener('resize', ()=>{ if(state.dockMode==='expanded') adjustDockHeight(); });

let mapInvalidationTimer=null;
function invalidateMapSoon(){ if(!state.map) return; clearTimeout(mapInvalidationTimer); mapInvalidationTimer=setTimeout(()=> state.map.invalidateSize(), 80); }

/*** Map ***/
function initMap(){
  if(state.map) return;

  state.map = L.map('map', { zoomControl:false }).setView([46.0569, 14.5058], 12);

  // Primarni OSM tile layer (subdomene)
  let activeLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    subdomains:['a','b','c'],
    maxZoom:19,
    attribution:'¬© OpenStreetMap'
  }).addTo(state.map);

  // Fallback na single-host, ƒçe pride do napak pri plo≈°ƒçicah
  let triedFallback=false;
  activeLayer.on('tileerror', ()=>{
    if(triedFallback) return;
    triedFallback=true;
    state.map.removeLayer(activeLayer);
    activeLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:19, attribution:'¬© OpenStreetMap'
    }).addTo(state.map);
  });

  // invalidate po prikazu
  setTimeout(()=> state.map && state.map.invalidateSize(), 60);

  // live uporabniki
  if(state.unsub.users) state.unsub.users();
  state.unsub.users = db.collection('users').onSnapshot(s=>{
    s.docs.forEach(d=> placeOrUpdateMarker({ uid:d.id, ...d.data() }));
  });

  // geolokacija
  askLocation();
}
function emojiDivIcon(emoji='üë§', name=''){
  const html = `
    <div style="display:flex;flex-direction:column;align-items:center;transform:translateY(-8px);">
      <div style="font-size:26px;filter:drop-shadow(0 2px 4px rgba(0,0,0,.6));">${esc(emoji)}</div>
      <div class="emoji-label">${esc(name||'')}</div>
    </div>`;
  return L.divIcon({ html, className:'', iconSize:[40,40], iconAnchor:[20,34] });
}
function placeOrUpdateMarker(u){
  const { uid, name, emoji='üß≠', loc } = u || {};
  if(!uid || !loc || loc.lat==null || loc.lng==null) return;
  const existing = state.markers.get(uid);
  if (existing) {
    existing.setLatLng([loc.lat, loc.lng]);
    existing.setIcon(emojiDivIcon(emoji, name||''));
  } else {
    const m = L.marker([loc.lat, loc.lng], { icon: emojiDivIcon(emoji, name||'') }).addTo(state.map);
    m.on('click', ()=> openProfileView(uid));
    state.markers.set(uid, m);
  }
}
async function updateMyLocation(lat,lng){
  if(!auth.currentUser) return;
  await db.collection('users').doc(auth.currentUser.uid).set({ loc:{lat,lng} }, { merge:true });
}
function askLocation(){
  if(!('geolocation' in navigator)){ showLocBanner(false); toast('Tvoj brskalnik ne podpira geolokacije.'); return; }
  showLocBanner(false);
  navigator.geolocation.getCurrentPosition(
    pos=>{ updateMyLocation(pos.coords.latitude, pos.coords.longitude); startLocWatch(); },
    err=>{ console.warn(err); showLocBanner(true); toast('Dovoli lokacijo (HTTPS ali localhost).'); },
    { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
  );
}
function startLocWatch(){
  if(!('geolocation' in navigator)) return;
  if(state.locWatchId) navigator.geolocation.clearWatch(state.locWatchId);
  state.locWatchId = navigator.geolocation.watchPosition(
    pos=> updateMyLocation(pos.coords.latitude, pos.coords.longitude),
    ()=>{}, { enableHighAccuracy:true, maximumAge:5000 }
  );
}
$('#btnAskLoc').onclick = askLocation;

/*** Helpers ***/
const fmtAge = dob=>{ if(!dob) return '‚Äî'; const d=new Date(dob); if(isNaN(d)) return '‚Äî'; return Math.floor((Date.now()-d.getTime())/31557600000); };
const formatTime = ts => { const d=ts?.toDate?.() ?? new Date(); return new Date(d).toLocaleString(); };
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} }
function clearUnsubs(keys){ keys.forEach(k=>{ if(state.unsub[k]){ state.unsub[k](); state.unsub[k]=null; } }); }

/*** Auth ***/
$('#btnAnon').onclick = ()=> auth.signInAnonymously();
$('#btnLogin').onclick = async ()=>{
  try{ await auth.signInWithEmailAndPassword($('#loginEmail').value.trim(), $('#loginPass').value); }
  catch(e){ alert(e.message); }
};
$('#btnRegister').onclick = async ()=>{
  const name=$('#regName').value.trim(), dob=$('#regDob').value, email=$('#regEmail').value.trim(), pass=$('#regPass').value;
  if(!name||!dob||!email||!pass){ alert('Izpolni vsa polja.'); return; }
  try{
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    await db.collection('users').doc(cred.user.uid).set({ name, dob, email, score:0, bio:'', emoji:'üôÇ', loc:null, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
  }catch(e){ alert(e.message); }
};

auth.onAuthStateChanged(async user=>{
  if(!user){ $('#auth').style.display='grid'; $('#app').style.display='none'; return; }
  $('#auth').style.display='none'; $('#app').style.display='block';

  const meRef = db.collection('users').doc(user.uid);
  const meDoc = await meRef.get();
  if(!meDoc.exists) await meRef.set({ name:'Uporabnik', dob:'', email:user.email||'', score:0, bio:'', emoji:'üôÇ', loc:null });
  state.me = { uid:user.uid, ...(await meRef.get()).data() };

  initMap();
  wireInbox();
  setDockShrunk();
  // zagotovi, da se mapa pravilno izri≈°e
  setTimeout(()=> state.map && state.map.invalidateSize(), 60);
});

/*** Base navigation ***/
$('#btnFriends').onclick = ()=> (state.view==='friends' && state.dockMode==='shrunk') ? openFriends() : (state.view==='friends' ? setDockShrunk() : openFriends());
$('#btnSearch').onclick  = ()=> (state.view==='search'  && state.dockMode==='shrunk') ? openSearch()  : (state.view==='search'  ? setDockShrunk() : openSearch());
$('#btnProfile').onclick = ()=> (state.view==='profile' && state.dockMode==='shrunk') ? openMyProfile(): (state.view==='profile' ? setDockShrunk() : openMyProfile());

/*** Rendering helper (always replace same area) ***/
function render(html,{search=false,chat=false}={}){
  $('#dockContent').innerHTML = html;
  setDockExpanded({search,chat});
}

/*** Friends ***/
async function openFriends(){
  state.view='friends'; clearUnsubs(['chat']); $('#chatComposer').style.display='none'; $('#searchToolbar').style.display='none';

  render(`<h3 style="margin:4px 2px 8px;">Prijatelji</h3><div id="friendsList" class="list"></div>`);

  if(state.unsub.friends) state.unsub.friends();
  state.unsub.friends = db.collection('users').doc(auth.currentUser.uid).collection('friends').onSnapshot(async snap=>{
    const list=$('#friendsList'); list.innerHTML='';
    if(snap.empty){ list.append(el('div','muted','≈†e nima≈° prijateljev. Pojdi na Iskanje üîé in dodaj koga.')); adjustDockHeight(); return; }
    const ids=snap.docs.map(d=>d.id);
    const gets=await Promise.all(ids.map(id=>db.collection('users').doc(id).get()));
    gets.forEach(g=>{
      const f={ uid:g.id, ...g.data() };
      const row=el('div','item'); row.innerHTML=`
        <div class="left">
          <div class="avatar">${esc(f.emoji||'üë§')}</div>
          <div><div><strong>${esc(f.name||'Uporabnik')}</strong></div><div class="muted">${esc(f.bio||'')}</div></div>
        </div>
        <div><button class="btn-primary">Pogovor</button> <button class="btn-ghost">Profil</button></div>`;
      const [bChat,bProf]=row.querySelectorAll('button');
      bChat.onclick=()=>openChat(f.uid); bProf.onclick=()=>openProfileView(f.uid);
      list.append(row);
    });
    adjustDockHeight();
  });
}

/*** Chat ***/
function chatId(a,b){ return [a,b].sort().join('__'); }
async function openChat(fid){
  state.view='chat'; state.chatWith=fid; clearUnsubs(['chat']); $('#searchToolbar').style.display='none';
  const fdoc=await db.collection('users').doc(fid).get(); const f=fdoc.data()||{name:'Uporabnik',emoji:'üë§'};
  render(`
    <div class="chat-header">
      <button class="btn-ghost" id="backFriends">‚Üê Nazaj</button>
      <div style="flex:1;text-align:center;cursor:pointer" id="chatTitle"><strong>${esc(f.name)}</strong></div>
      <span class="muted">Chat</span>
    </div>
    <div id="msgList" class="chat-box"></div>
  `,{chat:true});
  $('#backFriends').onclick=openFriends; $('#chatTitle').onclick=()=>openProfileView(fid);

  const cid=chatId(auth.currentUser.uid,fid);
  state.unsub.chat = db.collection('chats').doc(cid).collection('messages').orderBy('createdAt','asc')
    .onSnapshot(s=>{
      const box=$('#msgList'); box.innerHTML='';
      s.docs.forEach(d=>{
        const m=d.data(); const mine=m.from===auth.currentUser.uid;
        const b=el('div','msg '+(mine?'me':'them'));
        b.innerHTML=`<div>${esc(m.text||'')}</div><div class="time">${formatTime(m.createdAt)}</div>`;
        box.append(b);
      });
      box.scrollTop=box.scrollHeight; adjustDockHeight();
    });
}
$('#btnSend').onclick = async ()=>{
  const t=$('#chatInput').value.trim(); if(!t||!state.chatWith) return; $('#chatInput').value='';
  const cid=chatId(auth.currentUser.uid,state.chatWith);
  await db.collection('chats').doc(cid).collection('messages').add({from:auth.currentUser.uid,to:state.chatWith,text:t,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
  await db.collection('inbox').add({type:'message',from:auth.currentUser.uid,to:state.chatWith,text:t,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
};

/*** Inbox toasts ***/
function wireInbox(){
  if(state.unsub.inbox) state.unsub.inbox();
  state.unsub.inbox = db.collection('inbox').where('to','==',auth.currentUser.uid).orderBy('createdAt','desc').limit(1)
    .onSnapshot(async s=>{
      if(s.empty) return;
      const it=s.docs[0].data();
      if(it.type==='message' && !(state.view==='chat' && state.chatWith===it.from)){
        const u=(await db.collection('users').doc(it.from).get()).data(); toast(`${u?.name||'Nekdo'} ti je poslal sporoƒçilo`);
      }
      if(it.type==='friend_request'){ const u=(await db.collection('users').doc(it.from).get()).data(); toast(`${u?.name||'Nekdo'} te je dodal`); }
    });
}

/*** Profile (mine) ***/
async function openMyProfile(){
  state.view='profile'; clearUnsubs(['chat']); $('#searchToolbar').style.display='none'; $('#chatComposer').style.display='none';
  const me=(await db.collection('users').doc(auth.currentUser.uid).get()).data()||{};
  render(`
    <h3 style="margin:4px 2px 8px;">Moj profil</h3>
    <div class="list">
      <div class="item">
        <div class="left"><div class="avatar">${esc(me.emoji||'üôÇ')}</div><div><strong>Ime</strong><div class="muted">Kako naj te prikazuje</div></div></div>
        <div style="flex:1;max-width:60%"><input id="meName" value="${esc(me.name||'')}" /></div>
      </div>
      <div class="item">
        <div class="left"><div class="avatar">üìù</div><div><strong>Opis</strong><div class="muted">Kratek bio</div></div></div>
        <div style="flex:1;max-width:70%"><input id="meBio" value="${esc(me.bio||'')}" /></div>
      </div>
      <div class="item">
        <div class="left"><div class="avatar">üé≠</div><div><strong>Emoji</strong><div class="muted">Za marker na zemljevidu</div></div></div>
        <div style="flex:1;max-width:40%"><input id="meEmoji" value="${esc(me.emoji||'üôÇ')}" /></div>
      </div>
      <div class="item">
        <div class="left"><div class="avatar">üéÇ</div><div><strong>Rojstni datum</strong><div class="muted">Starost: ${fmtAge(me.dob)}</div></div></div>
        <span class="muted">${esc(me.dob||'‚Äî')}</span>
      </div>
      <div class="item">
        <div class="left"><div class="avatar">üéØ</div><div><strong>Score</strong><div class="muted">Samodejno (demo)</div></div></div>
        <span class="muted">${me.score ?? 0}</span>
      </div>
      <div class="list" style="gap:10px">
        <div class="row"><button id="btnSaveMe" class="btn-primary">Shrani</button><button id="btnSetLoc" class="btn-ghost">Dovoli/Osve≈æi lokacijo</button><button id="btnLogout" class="btn-danger">Odjava</button></div>
      </div>
    </div>
  `);
  $('#btnSaveMe').onclick = async ()=>{
    const name=$('#meName').value.trim(), bio=$('#meBio').value.trim(), emoji=$('#meEmoji').value.trim()||'üôÇ';
    await db.collection('users').doc(auth.currentUser.uid).set({ name,bio,emoji },{merge:true});
    toast('Profil shranjen');
    const u=(await db.collection('users').doc(auth.currentUser.uid).get()).data();
    placeOrUpdateMarker({uid:auth.currentUser.uid,...u});
  };
  $('#btnSetLoc').onclick = askLocation;
  $('#btnLogout').onclick = ()=> auth.signOut();
}

/*** Profile (view other) ***/
async function openProfileView(uid){
  state.view='profileView'; clearUnsubs(['chat']); $('#searchToolbar').style.display='none'; $('#chatComposer').style.display='none';
  const doc=await db.collection('users').doc(uid).get();
  if(!doc.exists){ render(`<div class="list"><div class="item"><div>Uporabnik ne obstaja veƒç.</div><button id="back" class="btn-ghost">Nazaj</button></div></div>`); $('#back').onclick=openFriends; return; }
  const u=doc.data(); const isFriend=(await db.collection('users').doc(auth.currentUser.uid).collection('friends').doc(uid).get()).exists;
  render(`
    <div class="chat-header">
      <button class="btn-ghost" id="back">‚Üê Nazaj</button>
      <div style="flex:1;text-align:center"><strong>${esc(u.name||'Uporabnik')}</strong></div>
      <span class="muted">Profil</span>
    </div>
    <div class="list">
      <div class="item">
        <div class="left"><div class="avatar" style="font-size:34px">${esc(u.emoji||'üë§')}</div>
          <div><div><strong>${esc(u.name||'')}</strong></div><div class="muted">Starost: ${fmtAge(u.dob)} ‚Ä¢ Score: ${u.score ?? 0}</div></div>
        </div>
        <div class="muted">${esc(u.dob||'')}</div>
      </div>
      <div class="item"><div>${esc(u.bio||'‚Äî brez opisa ‚Äî')}</div></div>
      <div><button id="openChat" class="btn-ghost">Odpri chat</button> ${isFriend?'':`<button id="add" class="btn-primary">Dodaj</button>`}</div>
    </div>
  `);
  $('#back').onclick = ()=> (state.chatWith===uid ? openChat(uid) : openFriends());
  $('#openChat').onclick = ()=> openChat(uid);
  const add=$('#add'); if(add) add.onclick = async ()=>{
    await db.collection('friend_requests').add({ from:auth.currentUser.uid, to:uid, createdAt:firebase.firestore.FieldValue.serverTimestamp() });
    await db.collection('inbox').add({ type:'friend_request', from:auth.currentUser.uid, to:uid, createdAt:firebase.firestore.FieldValue.serverTimestamp() });
    toast('Pro≈°nja poslana');
  };
}

/*** Search ***/
function openSearch(){
  state.view='search'; clearUnsubs(['chat']); $('#chatComposer').style.display='none';
  render(`<div id="searchResults" class="list"></div>`, {search:true});
  $('#btnCloseSearch').onclick = ()=>{ $('#searchInput').value=''; setDockShrunk(); state.view=null; };
  $('#btnWhoAddedMe').onclick = loadWhoAddedMe;
  $('#searchInput').oninput = debounce(doSearch, 250);
}
async function doSearch(){
  const q=($('#searchInput').value||'').trim().toLowerCase(); const out=$('#searchResults'); out.innerHTML='';
  if(q.length<2){ out.append(el('div','muted','Vpi≈°i vsaj 2 znaka.')); adjustDockHeight(); return; }
  const snap=await db.collection('users').limit(50).get();
  const results=snap.docs.map(d=>({uid:d.id,...d.data()})).filter(u=>(u.name||'').toLowerCase().includes(q)||(u.email||'').toLowerCase().includes(q));
  if(results.length===0){ out.append(el('div','muted','Ni najdenih uporabnikov.')); adjustDockHeight(); return; }
  results.forEach(u=>{
    if(u.uid===auth.currentUser.uid) return;
    const row=el('div','item'); row.innerHTML=`
      <div class="left"><div class="avatar">${esc(u.emoji||'üë§')}</div>
      <div><div><strong>${esc(u.name||'')}</strong></div><div class="muted">${esc(u.email||'')}</div></div></div>
      <div><button class="btn-ghost">Profil</button></div>`;
    row.querySelector('button').onclick=()=>openProfileView(u.uid);
    out.append(row);
  });
  adjustDockHeight();
}
async function loadWhoAddedMe(){
  const out=$('#searchResults'); out.innerHTML='<div class="muted">Nalagam‚Ä¶</div>';
  const snap=await db.collection('friend_requests').where('to','==',auth.currentUser.uid).get();
  out.innerHTML='';
  if(snap.empty){ out.append(el('div','muted','Trenutno te nihƒçe ni dodal.')); adjustDockHeight(); return; }
  for(const d of snap.docs){
    const fr=d.data(); const u=(await db.collection('users').doc(fr.from).get()).data();
    const row=el('div','item'); row.innerHTML=`
      <div class="left"><div class="avatar">${esc(u?.emoji||'üë§')}</div>
      <div><div><strong>${esc(u?.name||'Uporabnik')}</strong></div><div class="muted">${esc(u?.email||'')}</div></div></div>
      <div><button class="btn-primary">Sprejmi</button> <button class="btn-ghost">Zavrni</button></div>`;
    const [accept,decline]=row.querySelectorAll('button');
    accept.onclick=async ()=>{
      await Promise.all([
        db.collection('users').doc(auth.currentUser.uid).collection('friends').doc(fr.from).set({at:firebase.firestore.FieldValue.serverTimestamp()}),
        db.collection('users').doc(fr.from).collection('friends').doc(auth.currentUser.uid).set({at:firebase.firestore.FieldValue.serverTimestamp()}),
        db.collection('friend_requests').doc(d.id).delete()
      ]);
      toast('Dodano med prijatelje'); doSearch();
    };
    decline.onclick=async ()=>{ await db.collection('friend_requests').doc(d.id).delete(); toast('Pro≈°nja zavrnjena'); doSearch(); };
    out.append(row);
  }
  adjustDockHeight();
}

/*** Page helpers ***/
document.addEventListener('visibilitychange', ()=> invalidateMapSoon());
</script>

</body>
</html>
