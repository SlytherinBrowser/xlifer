<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Xlifer ‚Äî dru≈æabno omre≈æje (Firebase, 1 datoteka)</title>
  <style>
    :root{
      --bg: #0b0f14; --card:#111824; --text:#e8eef6; --muted:#a7b1c2; --primary:#6ea8fe; --accent:#22c55e; --danger:#ef4444; --border:#1f2a3a;
    }
    [data-theme="light"]{ --bg:#f6f8fb; --card:#ffffff; --text:#0c1220; --muted:#4b5563; --primary:#2563eb; --accent:#16a34a; --danger:#dc2626; --border:#e5e7eb; }
    [data-theme="purple"]{ --bg:#0d0a1a; --card:#1a1233; --text:#f3e8ff; --muted:#c4b5fd; --primary:#8b5cf6; --accent:#22d3ee; --danger:#fb7185; --border:#2a1f4a; }
    [data-theme="forest"]{ --bg:#0c1310; --card:#101b16; --text:#e6f4ea; --muted:#9fb3a7; --primary:#34d399; --accent:#60a5fa; --danger:#f87171; --border:#1a2a22; }

    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    a{color:var(--primary);text-decoration:none}
    input,select,textarea,button{background:#0b0f14;color:var(--text)}
    .container{display:grid;grid-template-columns:280px 1fr 360px;gap:16px;max-width:1400px;margin:0 auto;padding:16px}
    header.topbar{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);padding:10px 16px;display:flex;align-items:center;gap:12px;z-index:10}
    header .brand{font-weight:800;letter-spacing:.3px}
    .btn{border:1px solid var(--border);background:var(--card);padding:8px 12px;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--primary);color:white;border-color:transparent}
    .btn.ghost{background:transparent}
    .btn.danger{background:var(--danger);color:white;border-color:transparent}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
    .stack{display:flex;gap:10px;align-items:center}
    .stack-col{display:flex;flex-direction:column;gap:10px}
    .hidden{display:none!important}
    .muted{color:var(--muted)}
    .input{width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);background:transparent}
    .avatar{width:40px;height:40px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .feed-img,.story-img{width:100%;border-radius:12px;border:1px solid var(--border)}
    .story-strip{display:flex;gap:10px;overflow-x:auto;padding-bottom:6px}
    .story{min-width:120px}
    .list{display:flex;flex-direction:column;gap:10px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    nav.tabs{display:flex;gap:8px;border-bottom:1px solid var(--border);margin-bottom:12px}
    nav.tabs button{border:none;background:transparent;padding:10px 12px;border-bottom:2px solid transparent;cursor:pointer;color:var(--muted)}
    nav.tabs button.active{color:var(--text);border-color:var(--primary)}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0c1220;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
    .pill{border:1px solid var(--border);border-radius:999px;padding:2px 8px}
    .notice{padding:8px 10px;border-left:3px solid var(--primary);background:rgba(0,0,0,.2);border-radius:8px}
    .row{display:flex;align-items:center;gap:10px}

    @media(max-width:1100px){ .container{grid-template-columns: 1fr;}
      aside.left, aside.right{order:2}
      main{order:1}
    }
  </style>
</head>
<body data-theme="dark">
  <header class="topbar">
    <div class="brand">üåê Xlifer</div>
    <div class="stack" id="authBar">
      <span class="muted">Ni prijave</span>
      <button class="btn primary" onclick="showView('auth')">Prijava / Registracija</button>
    </div>
    <div class="stack hidden" id="userBar">
      <img id="navAvatar" class="avatar" alt="avatar">
      <span id="navName"></span>
      <button class="btn" onclick="showView('feed')">Domov</button>
      <button class="btn" onclick="showView('profile')">Profil</button>
      <button class="btn" onclick="showView('friends')">Prijatelji</button>
      <button class="btn" onclick="showView('chat')">Chat</button>
      <select id="themeSelect" class="input" style="width:auto" title="Tema" onchange="setTheme(this.value)">
        <option value="dark">Temna</option>
        <option value="light">Svetla</option>
        <option value="purple">Vijoliƒçna</option>
        <option value="forest">Gozdna</option>
      </select>
      <button class="btn danger" onclick="logout()">Odjava</button>
    </div>
  </header>

  <div class="container">
    <aside class="left">
      <div class="card">
        <div class="stack">
          <img id="sideAvatar" class="avatar" alt="">
          <div class="stack-col">
            <strong id="sideName">Gost</strong>
            <span class="muted" id="sideEmail"></span>
          </div>
        </div>
        <div style="height:8px"></div>
        <div class="grid2">
          <div class="pill"><small>Objave: <span id="countPosts">0</span></small></div>
          <div class="pill"><small>Prijatelji: <span id="countFriends">0</span></small></div>
        </div>
      </div>
      <div class="card">
        <div class="stack-col">
          <strong>Dodaj zgodbo (story)</strong>
          <input id="storyImage" class="input" type="file" accept="image/*" />
          <button class="btn primary" onclick="addStory()">Objavi zgodbo (24h)</button>
          <small class="muted">Slike se shranijo v Firebase kot Base64, kot si ≈æelel.</small>
        </div>
      </div>
      <div class="card">
        <div class="stack-col">
          <strong>Nova objava</strong>
          <textarea id="postText" class="input" placeholder="Kaj se dogaja?" rows="3"></textarea>
          <input id="postImage" class="input" type="file" accept="image/*" />
          <button class="btn primary" onclick="createPost()">Objavi</button>
        </div>
      </div>
    </aside>

    <main>
      <!-- AUTH VIEW -->
      <section id="view-auth" class="card">
        <nav class="tabs">
          <button id="tabLogin" class="active" onclick="switchAuthTab('login')">Prijava</button>
          <button id="tabRegister" onclick="switchAuthTab('register')">Registracija</button>
        </nav>
        <div id="loginForm">
          <div class="grid2">
            <input id="loginEmail" class="input" placeholder="Email" />
            <input id="loginPass" class="input" placeholder="Geslo" type="password" />
          </div>
          <div style="height:8px"></div>
          <button class="btn primary" onclick="login()">Prijava</button>
        </div>
        <div id="registerForm" class="hidden">
          <div class="grid2">
            <input id="regName" class="input" placeholder="Ime in priimek" />
            <input id="regEmail" class="input" placeholder="Email" />
          </div>
          <div class="grid2" style="margin-top:8px">
            <input id="regPass" class="input" placeholder="Geslo" type="password" />
            <input id="regPass2" class="input" placeholder="Ponovi geslo" type="password" />
          </div>
          <div class="stack" style="margin-top:8px">
            <input id="regAvatar" type="file" accept="image/*" />
            <small class="muted">Neobvezno: nalo≈æi fotografijo</small>
          </div>
          <button class="btn primary" onclick="register()" style="margin-top:8px">Ustvari raƒçun</button>
        </div>
      </section>

      <!-- FEED VIEW -->
      <section id="view-feed" class="hidden">
        <div class="card">
          <strong>Zgodbe</strong>
          <div class="story-strip" id="storiesStrip"></div>
        </div>
        <div style="height:12px"></div>
        <div class="list" id="feedList"></div>
      </section>

      <!-- PROFILE VIEW -->
      <section id="view-profile" class="hidden card">
        <div class="stack">
          <img id="profileAvatar" class="avatar" alt="">
          <div class="stack-col" style="flex:1">
            <input id="profileName" class="input" placeholder="Ime" />
            <input id="profileBio" class="input" placeholder="Opis / Bio" />
          </div>
          <div class="stack-col">
            <label class="row"><input type="checkbox" id="profilePublic"> <span>Javni profil</span></label>
            <small class="muted">ƒåe je izklopljeno, je profil zaseben in tvoje objave vidijo samo prijatelji.</small>
          </div>
        </div>
        <div class="toolbar" style="margin-top:8px">
          <input id="profilePicFile" type="file" accept="image/*" />
          <button class="btn" onclick="saveProfile()">Shrani profil</button>
        </div>
      </section>

      <!-- FRIENDS VIEW -->
      <section id="view-friends" class="hidden card">
        <div class="grid2">
          <div>
            <strong>Najdi ljudi</strong>
            <input id="searchUser" class="input" placeholder="I≈°ƒçi po emailu ali imenu" oninput="searchUsers(this.value)" />
            <div id="searchResults" class="list" style="margin-top:8px"></div>
          </div>
          <div>
            <strong>Tvoji prijatelji</strong>
            <div id="friendsList" class="list" style="margin-top:8px"></div>
          </div>
        </div>
        <div style="height:12px"></div>
        <strong>Pro≈°nje za prijateljstvo</strong>
        <div id="requestsList" class="list" style="margin-top:8px"></div>
      </section>

      <!-- CHAT VIEW -->
      <section id="view-chat" class="hidden">
        <div class="grid2">
          <div class="card" style="max-height:70vh;overflow:auto">
            <div class="toolbar">
              <button class="btn primary" onclick="startDirectChatPrompt()">+ Nov 1‚Äëna‚Äë1</button>
              <button class="btn" onclick="startGroupChatPrompt()">+ Nova skupina</button>
            </div>
            <div id="chatList" class="list" style="margin-top:8px"></div>
          </div>
          <div class="card" style="max-height:70vh;display:flex;flex-direction:column">
            <div id="chatHeader" class="row" style="justify-content:space-between">
              <strong id="chatTitle">Izberi pogovor</strong>
              <small id="chatMembers" class="muted"></small>
            </div>
            <div id="messages" style="flex:1;overflow:auto;margin:10px 0;display:flex;flex-direction:column;gap:8px"></div>
            <div class="row">
              <input id="msgInput" class="input" placeholder="Sporoƒçilo..." onkeydown="if(event.key==='Enter'){sendMessage()}" />
              <input id="msgImage" type="file" accept="image/*" />
              <button class="btn primary" onclick="sendMessage()">Po≈°lji</button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <aside class="right">
      <div class="card notice">
        <strong>Navodila za zagon</strong>
        <ol>
          <li>Odpri <span class="kbd">index.html</span> v brskalniku.</li>
          <li>V spodnji kodi <strong>zamenjaj</strong> <span class="kbd">YOUR_FIREBASE_CONFIG</span> s svojimi podatki (Project settings ‚Üí SDK setup &amp; config).</li>
          <li>V konzoli Firebase <strong>omogoƒçi</strong> Authentication (Email/Password) in Firestore Database.</li>
        </ol>
        <small class="muted">Opomba: primer shranjuje slike kot Base64 v Firestore dokumentih (na tvojo ≈æeljo). Za veƒçje projekte priporoƒçam Firebase Storage.</small>
      </div>
      <div class="card">
        <strong>Nastavitve</strong>
        <div class="stack-col">
          <label>Izberi temo zgoraj v vrstici.</label>
          <label class="row"><input type="checkbox" id="showPublicOnly" onchange="renderFeed()"> Prika≈æi samo javne objave</label>
        </div>
      </div>
    </aside>
  </div>

  <!-- Firebase SDK (v9 modular preko CDN) -->
  <script type="module">
    // ‚öôÔ∏è 1) VSTAVI SVOJO FIREBASE KONFIGURACIJO
    const firebaseConfig = /** @type {import('firebase/app').FirebaseOptions} */ ({
      apiKey: "YOUR_FIREBASE_CONFIG_apiKey",
      authDomain: "YOUR_FIREBASE_CONFIG_authDomain",
      projectId: "YOUR_FIREBASE_CONFIG_projectId",
      storageBucket: "YOUR_FIREBASE_CONFIG_storageBucket", // neuporabljeno pri Base64
      messagingSenderId: "YOUR_FIREBASE_CONFIG_messagingSenderId",
      appId: "YOUR_FIREBASE_CONFIG_appId"
    });

    // 2) Uvoz Firebase modulov
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp, collection, addDoc, query, where, orderBy, onSnapshot, getDocs, or } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // üîß Global state
    let currentUser = null;
    let activeChatId = null;

    // üì¶ Helperji
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    function showView(name){
      ['auth','feed','profile','friends','chat'].forEach(v=>$('#view-'+v)?.classList.add('hidden'));
      $('#view-'+name)?.classList.remove('hidden');
    }
    function setTheme(t){ document.body.setAttribute('data-theme', t); localStorage.setItem('xlifer-theme', t); }
    setTheme(localStorage.getItem('xlifer-theme')||'dark');

    function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const r=new FileReader(); r.onload=()=>resolve(r.result); r.onerror=reject; r.readAsDataURL(file);
      });
    }

    function timeago(ts){
      const d = ts?.toDate ? ts.toDate() : (ts instanceof Date? ts : new Date(ts));
      const diff = Math.floor((Date.now()-d.getTime())/1000);
      const units=[[31536000,'leto'],[2592000,'mesec'],[604800,'teden'],[86400,'dan'],[3600,'ura'],[60,'min'],[1,'s']];
      for(const [sec,label] of units){ if(diff>=sec) return Math.floor(diff/sec)+" "+label+ (Math.floor(diff/sec)>1 && label!=='s'?'i':'') + ' nazaj'; }
      return 'zdaj';
    }

    // üîê Auth
    window.switchAuthTab = (t)=>{
      $('#tabLogin').classList.toggle('active', t==='login');
      $('#tabRegister').classList.toggle('active', t==='register');
      $('#loginForm').classList.toggle('hidden', t!=='login');
      $('#registerForm').classList.toggle('hidden', t!=='register');
    }

    window.register = async ()=>{
      const name = $('#regName').value.trim();
      const email = $('#regEmail').value.trim();
      const pass = $('#regPass').value.trim();
      const pass2 = $('#regPass2').value.trim();
      if(!name||!email||!pass||pass!==pass2){ alert('Preveri polja.'); return; }
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      let photoBase64 = '';
      const f = $('#regAvatar').files?.[0];
      if(f) photoBase64 = await fileToBase64(f);
      await updateProfile(cred.user, { displayName:name, photoURL: photoBase64||null });
      await setDoc(doc(db,'users',cred.user.uid),{
        uid: cred.user.uid,
        name, email,
        photoBase64,
        bio:'',
        publicProfile:true,
        friendsCount:0, postsCount:0,
        createdAt: serverTimestamp()
      });
    }

    window.login = async ()=>{
      const email = $('#loginEmail').value.trim();
      const pass = $('#loginPass').value.trim();
      await signInWithEmailAndPassword(auth, email, pass);
    }

    window.logout = ()=> signOut(auth);

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user;
      if(!user){
        $('#authBar').classList.remove('hidden');
        $('#userBar').classList.add('hidden');
        showView('auth');
        return;
      }
      $('#authBar').classList.add('hidden');
      $('#userBar').classList.remove('hidden');
      $('#navName').textContent = user.displayName || user.email;
      $('#navAvatar').src = user.photoURL || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"><rect width="100%" height="100%" fill="%231f2a3a"/><text x="50%" y="55%" font-size="14" fill="white" text-anchor="middle">üôÇ</text></svg>';
      $('#sideAvatar').src = $('#navAvatar').src; $('#sideName').textContent = user.displayName||'Uporabnik'; $('#sideEmail').textContent = user.email||'';

      // Nalo≈æi profil
      const uref = doc(db,'users', user.uid);
      const snap = await getDoc(uref);
      if(snap.exists()){
        const u = snap.data();
        $('#profileName').value = u.name||'';
        $('#profileBio').value = u.bio||'';
        $('#profilePublic').checked = u.publicProfile!==false;
        $('#countFriends').textContent = u.friendsCount||0;
        $('#countPosts').textContent = u.postsCount||0;
        if(u.photoBase64){ $('#profileAvatar').src = u.photoBase64; $('#navAvatar').src = u.photoBase64; $('#sideAvatar').src=u.photoBase64; }
      }
      showView('feed');
      subscribeFeed();
      subscribeStories();
      subscribeChats();
      loadFriendsUI();
    });

    // üë§ Profil
    window.saveProfile = async ()=>{
      if(!currentUser) return;
      const name = $('#profileName').value.trim();
      const bio = $('#profileBio').value.trim();
      const publicProfile = $('#profilePublic').checked;
      let photoBase64 = null;
      const f = $('#profilePicFile').files?.[0];
      if(f) photoBase64 = await fileToBase64(f);
      const upd = { name, bio, publicProfile };
      if(photoBase64) upd.photoBase64 = photoBase64;
      await updateDoc(doc(db,'users',currentUser.uid), upd);
      await updateProfile(currentUser,{ displayName:name, photoURL: photoBase64||currentUser.photoURL||null });
      alert('Profil shranjen.');
      $('#navName').textContent = name||currentUser.email;
      if(photoBase64){ $('#profileAvatar').src = photoBase64; $('#navAvatar').src=photoBase64; $('#sideAvatar').src=photoBase64; }
    }

    // üì∞ Objave
    async function buildFeedQuery(){
      const showPublicOnly = $('#showPublicOnly').checked;
      if(showPublicOnly){
        return query(collection(db,'posts'), where('public','==',true), orderBy('createdAt','desc'));
      }
      // Prika≈æi: moje + prijateljev + javne
      const myUid = currentUser.uid;
      const friends = await getFriendUids(myUid);
      const allowed = new Set([myUid, ...friends]);
      // Firestore ne podpira dinamiƒçnega IN; prikaz re≈°imo z naroƒçnino na javne + moje + prijatelje posebej in zdru≈æimo.
      return null; // uporabljamo subscribeFeed(), ki zdru≈æuje tri tokove
    }

    let unsubPublic=null,unsubMine=null,unsubFriends=[];
    function clearFeedSubs(){ unsubPublic&&unsubPublic(); unsubMine&&unsubMine(); unsubFriends.forEach(u=>u()); unsubFriends=[]; }

    async function subscribeFeed(){
      if(!currentUser) return;
      clearFeedSubs();
      const myUid = currentUser.uid;
      const friends = await getFriendUids(myUid);
      const feed = new Map();
      const render = ()=>{
        const items = Array.from(feed.values()).sort((a,b)=> (b.createdAt?.toMillis?.()||0)-(a.createdAt?.toMillis?.()||0));
        const el = $('#feedList'); el.innerHTML='';
        for(const p of items){ el.appendChild(renderPostCard(p)); }
      }
      unsubPublic = onSnapshot(query(collection(db,'posts'), where('public','==',true), orderBy('createdAt','desc')), s=>{ s.docChanges().forEach(c=>{ if(c.type==='removed'){ feed.delete(c.doc.id);} else { feed.set(c.doc.id,{id:c.doc.id,...c.doc.data()}); } }); render(); });
      unsubMine = onSnapshot(query(collection(db,'posts'), where('uid','==',myUid), orderBy('createdAt','desc')), s=>{ s.docChanges().forEach(c=>{ if(c.type==='removed'){ feed.delete(c.doc.id);} else { feed.set(c.doc.id,{id:c.doc.id,...c.doc.data()}); } }); render(); });
      for(const fuid of friends){
        const u = onSnapshot(query(collection(db,'posts'), where('uid','==',fuid), orderBy('createdAt','desc')), s=>{ s.docChanges().forEach(c=>{ if(c.type==='removed'){ feed.delete(c.doc.id);} else { feed.set(c.doc.id,{id:c.doc.id,...c.doc.data()}); } }); render(); });
        unsubFriends.push(u);
      }
    }

    function renderPostCard(p){
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `
        <div class="row">
          <img class="avatar" src="${p.authorPhoto||''}" onerror="this.style.visibility='hidden'">
          <div class="stack-col" style="flex:1">
            <strong>${p.authorName||'Uporabnik'}</strong>
            <small class="muted">${timeago(p.createdAt)}</small>
          </div>
          ${p.public?'<span class="pill">Javno</span>':'<span class="pill">Samo prijatelji</span>'}
        </div>
        ${p.text?`<p style="white-space:pre-wrap">${escapeHtml(p.text)}</p>`:''}
        ${p.imageBase64?`<img class="feed-img" src="${p.imageBase64}" alt="objava">`:''}
      `;
      return card;
    }

    function escapeHtml(s){ return s?.replace(/[&<>'"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;","\"":"&quot;"}[c]))||'' }

    window.createPost = async ()=>{
      if(!currentUser) return;
      const text = $('#postText').value.trim();
      let imageBase64='';
      const f = $('#postImage').files?.[0];
      if(f) imageBase64 = await fileToBase64(f);
      const userDoc = (await getDoc(doc(db,'users',currentUser.uid))).data();
      const isPublic = userDoc?.publicProfile!==false;
      await addDoc(collection(db,'posts'),{
        uid: currentUser.uid,
        authorName: userDoc?.name||currentUser.displayName||'Uporabnik',
        authorPhoto: userDoc?.photoBase64||currentUser.photoURL||'',
        text, imageBase64,
        public: isPublic,
        createdAt: serverTimestamp()
      });
      $('#postText').value=''; $('#postImage').value='';
      await updateDoc(doc(db,'users',currentUser.uid),{ postsCount: (userDoc?.postsCount||0)+1 });
    }

    // üìö Zgodbe (24h)
    function subscribeStories(){
      onSnapshot(query(collection(db,'stories'), orderBy('createdAt','desc')), s=>{
        const host = $('#storiesStrip'); host.innerHTML='';
        const now = Date.now();
        s.forEach(d=>{
          const st = d.data(); const exp = st.expiresAt?.toMillis?.() || 0; if(exp && exp < now) return; // poteƒçene ne prikazujemo
          const el = document.createElement('div'); el.className='story';
          el.innerHTML = `<img class="story-img" src="${st.imageBase64}" alt="story"><div class="muted" style="margin-top:4px">${st.authorName||'Uporabnik'}</div>`;
          host.appendChild(el);
        });
      });
    }

    window.addStory = async ()=>{
      const f = $('#storyImage').files?.[0]; if(!f){ alert('Izberi sliko.'); return; }
      const imageBase64 = await fileToBase64(f);
      const u = (await getDoc(doc(db,'users',currentUser.uid))).data();
      const expires = new Date(Date.now()+24*60*60*1000);
      await addDoc(collection(db,'stories'),{
        uid: currentUser.uid,
        authorName: u?.name||currentUser.displayName||'',
        imageBase64,
        createdAt: serverTimestamp(),
        expiresAt: expires
      });
      $('#storyImage').value='';
    }

    // ü§ù Prijatelji
    async function getFriendUids(uid){
      const q1 = await getDocs(query(collection(db,'friends'), where('a','==',uid)));
      const q2 = await getDocs(query(collection(db,'friends'), where('b','==',uid)));
      const ids = new Set(); q1.forEach(d=>ids.add(d.data().b)); q2.forEach(d=>ids.add(d.data().a));
      return Array.from(ids);
    }

    window.searchUsers = async (term)=>{
      const box = $('#searchResults'); box.innerHTML='';
      if(!term) return;
      const byEmail = await getDocs(query(collection(db,'users'), where('email','==',term)));
      const byName = await getDocs(query(collection(db,'users'), where('name','>=',term), where('name','<=',term+"\uf8ff")));
      const seen = new Set();
      function addCard(u){ if(seen.has(u.uid)||u.uid===currentUser?.uid) return; seen.add(u.uid); const c=document.createElement('div'); c.className='card'; c.innerHTML=`<div class="row"><img class="avatar" src="${u.photoBase64||''}" onerror="this.style.visibility='hidden'"> <div class="stack-col" style="flex:1"><strong>${u.name||u.email}</strong><small class=muted>${u.email||''}</small></div><button class="btn" onclick="sendFriendRequest('${u.uid}')">Dodaj</button></div>`; box.appendChild(c) }
      byEmail.forEach(d=>addCard(d.data())); byName.forEach(d=>addCard(d.data()));
    }

    window.sendFriendRequest = async (toUid)=>{
      await addDoc(collection(db,'friendRequests'),{ from: currentUser.uid, to: toUid, createdAt: serverTimestamp(), status:'pending' });
      alert('Pro≈°nja poslana.');
    }

    async function loadFriendsUI(){
      // Prijatelji
      const fl = $('#friendsList'); fl.innerHTML='';
      const ids = await getFriendUids(currentUser.uid);
      for(const uid of ids){
        const u = (await getDoc(doc(db,'users',uid))).data();
        const c = document.createElement('div'); c.className='card'; c.innerHTML=`<div class="row"><img class="avatar" src="${u?.photoBase64||''}" onerror="this.style.visibility='hidden'"> <div class="stack-col" style="flex:1"><strong>${u?.name||u?.email||'Uporabnik'}</strong><small class="muted">${u?.email||''}</small></div><button class="btn" onclick="startDirectChat('${uid}')">Pogovor</button></div>`; fl.appendChild(c);
      }
      // Pro≈°nje
      const rq = await getDocs(query(collection(db,'friendRequests'), where('to','==',currentUser.uid), where('status','==','pending')));
      const box = $('#requestsList'); box.innerHTML='';
      rq.forEach(async d=>{
        const r = d.data(); const u = (await getDoc(doc(db,'users',r.from))).data();
        const c = document.createElement('div'); c.className='card'; c.innerHTML=`<div class="row"><img class="avatar" src="${u?.photoBase64||''}" onerror="this.style.visibility='hidden'"> <div class="stack-col" style="flex:1"><strong>${u?.name||u?.email}</strong><small class="muted">≈æeli biti prijatelj</small></div><div class="toolbar"><button class="btn primary" onclick="acceptRequest('${d.id}','${r.from}')">Sprejmi</button><button class="btn ghost" onclick="declineRequest('${d.id}')">Zavrni</button></div></div>`; box.appendChild(c);
      });
    }

    window.acceptRequest = async (reqId, otherUid)=>{
      // Dodaj povezavo (neusmerjena: shranimo (a,b))
      await addDoc(collection(db,'friends'),{ a: currentUser.uid, b: otherUid, createdAt: serverTimestamp() });
      await updateDoc(doc(db,'friendRequests',reqId),{ status:'accepted' });
      // ≈†tevec
      const me = await getDoc(doc(db,'users',currentUser.uid));
      const him = await getDoc(doc(db,'users',otherUid));
      await updateDoc(doc(db,'users',currentUser.uid),{ friendsCount:(me.data()?.friendsCount||0)+1 });
      await updateDoc(doc(db,'users',otherUid),{ friendsCount:(him.data()?.friendsCount||0)+1 });
      loadFriendsUI(); subscribeFeed();
    }
    window.declineRequest = async (reqId)=>{ await updateDoc(doc(db,'friendRequests',reqId),{ status:'declined' }); loadFriendsUI(); }

    // üí¨ Chat (1-1 in skupinski)
    function subscribeChats(){
      if(!currentUser) return;
      onSnapshot(query(collection(db,'chats'), where('members','array-contains', currentUser.uid), orderBy('updatedAt','desc')), s=>{
        const box = $('#chatList'); box.innerHTML='';
        s.forEach(d=>{
          const c = d.data();
          const el = document.createElement('div'); el.className='card'; el.innerHTML = `<div class="row" style="cursor:pointer" onclick="openChat('${d.id}', '${escapeHtml(c.name||'Pogovor')}')"><strong>${c.name||'Pogovor'}</strong><small class="muted" style="margin-left:auto">${timeago(c.updatedAt)}</small></div>`; box.appendChild(el);
        })
      })
    }

    window.openChat = async (chatId, title)=>{
      activeChatId = chatId; $('#chatTitle').textContent = title; $('#messages').innerHTML='';
      const cs = await getDoc(doc(db,'chats', chatId));
      const cdata = cs.data(); $('#chatMembers').textContent = 'ƒålani: '+(cdata?.members?.length||1);
      onSnapshot(query(collection(db,'chats',chatId,'messages'), orderBy('createdAt','asc')), s=>{
        const box = $('#messages'); box.innerHTML='';
        s.forEach(d=>{
          const m = d.data();
          const row = document.createElement('div'); row.className='card';
          row.innerHTML = `<div class="stack"><span class="pill">${m.fromName||m.from}</span><small class="muted">${timeago(m.createdAt)}</small></div>${m.text?`<div style="margin-top:6px">${escapeHtml(m.text)}</div>`:''}${m.imageBase64?`<img class="feed-img" src="${m.imageBase64}">`:''}`;
          box.appendChild(row);
          box.scrollTop = box.scrollHeight;
        })
      })
      showView('chat');
    }

    window.sendMessage = async ()=>{
      if(!activeChatId) return;
      const text = $('#msgInput').value.trim();
      let imageBase64='';
      const f = $('#msgImage').files?.[0]; if(f) imageBase64 = await fileToBase64(f);
      const u = (await getDoc(doc(db,'users',currentUser.uid))).data();
      await addDoc(collection(db,'chats',activeChatId,'messages'),{
        from: currentUser.uid,
        fromName: u?.name||currentUser.displayName||'',
        text, imageBase64,
        createdAt: serverTimestamp()
      });
      await updateDoc(doc(db,'chats',activeChatId),{ updatedAt: serverTimestamp() });
      $('#msgInput').value=''; $('#msgImage').value='';
    }

    window.startDirectChatPrompt = async ()=>{
      const email = prompt('Vnesi email osebe:'); if(!email) return;
      const q = await getDocs(query(collection(db,'users'), where('email','==',email)));
      if(q.empty){ alert('Ni uporabnika.'); return; }
      const other = q.docs[0].data();
      startDirectChat(other.uid);
    }

    window.startDirectChat = async (otherUid)=>{
      const name = '1‚Äëna‚Äë1';
      const docRef = await addDoc(collection(db,'chats'),{ name, isGroup:false, members:[currentUser.uid, otherUid], updatedAt: serverTimestamp() });
      openChat(docRef.id, name);
    }

    window.startGroupChatPrompt = async ()=>{
      const emails = prompt('Vnesi emaile ƒçlanov, loƒçene z vejicami:'); if(!emails) return;
      const parts = emails.split(',').map(s=>s.trim()).filter(Boolean);
      const memberUids = [currentUser.uid];
      for(const e of parts){ const q=await getDocs(query(collection(db,'users'), where('email','==',e))); if(!q.empty) memberUids.push(q.docs[0].data().uid); }
      const name = prompt('Ime skupine?')||'Skupinski chat';
      const docRef = await addDoc(collection(db,'chats'),{ name, isGroup:true, members: Array.from(new Set(memberUids)), updatedAt: serverTimestamp() });
      openChat(docRef.id, name);
    }

    // üßµ Stories & Posts: UI render preklop
    window.renderFeed = ()=>{ subscribeFeed(); }

    // üìà ≈†tevilke (posodobitve v stranski vrstici) ‚Äì kliƒçemo ob spremembah
    // (Preprosto: ob nalaganju jih postavimo; bolj natanƒçno bi zahtevalo transakcije.)

    // ‚ö†Ô∏è Varnostne opombe (preberi!):
    // - Obvezno nastavi Firestore Rules, da za≈°ƒçiti≈° zasebne profile in sporoƒçila.
    //   Minimalni osnutek (prilagodi svojim potrebam):
    //   rules_version = '2'; service cloud.firestore { match /databases/{db}/documents {
    //     match /users/{uid} { allow read: if resource.data.publicProfile == true || request.auth != null && request.auth.uid == uid; allow write: if request.auth != null && request.auth.uid == uid; }
    //     match /posts/{id} { allow read: if resource.data.public == true || request.auth != null; allow create: if request.auth != null; allow update, delete: if request.auth != null && request.auth.uid == resource.data.uid; }
    //     match /stories/{id} { allow read: if true; allow write: if request.auth != null; }
    //     match /friendRequests/{id} { allow read, write: if request.auth != null; }
    //     match /friends/{id} { allow read, write: if request.auth != null; }
    //     match /chats/{cid} { allow read, write: if request.auth != null && request.auth.uid in resource.data.members; match /messages/{mid} { allow read, write: if request.auth != null && request.auth.uid in get(/databases/$(db)/documents/chats/$(cid)).data.members; } }
    //   }}
    // - Shranjevanje slik kot Base64 v Firestore je enostavno, vendar lahko poveƒça stro≈°ke in velikost dokumentov. Za produkcijo raje uporabi Firebase Storage.

  </script>
</body>
</html>
