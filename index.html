<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XLifer</title>
  <!-- Leaflet (zemljevid) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
    defer
  ></script>

  <!-- Firebase (modular SDK) -->
  <script type="module" defer>
    // üîß 1) Vnesi svoje Firebase nastavitve spodaj
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAhA1s2iiJDMMeqoOrp1asJO1eha_R0ivg",
  authDomain: "slychat1-b76db.firebaseapp.com",
  databaseURL: "https://slychat1-b76db-default-rtdb.firebaseio.com",
  projectId: "slychat1-b76db",
  storageBucket: "slychat1-b76db.firebasestorage.app",
  messagingSenderId: "508879069664",
  appId: "1:508879069664:web:ce963d111297cd3480cb85",
  measurementId: "G-D34XJNNGNQ"
};

    // ‚ö†Ô∏è BREZ tega XLifer ne bo deloval. Pridobi vrednosti iz Firebase Console > Project Settings.

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      sendPasswordResetEmail,
      signOut,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      updateDoc,
      collection,
      addDoc,
      getDocs,
      query,
      where,
      orderBy,
      onSnapshot,
      serverTimestamp,
      writeBatch,
      limit,
      startAt,
      endAt
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ------- UI ELEMENTS -------
    const authView = document.getElementById('auth-view');
    const appView  = document.getElementById('app-view');

    const regForm = document.getElementById('reg-form');
    const regName = document.getElementById('reg-name');
    const regEmail = document.getElementById('reg-email');
    const regPass = document.getElementById('reg-pass');
    const regDob  = document.getElementById('reg-dob');

    const loginForm = document.getElementById('login-form');
    const loginName = document.getElementById('login-name'); // opcijsko
    const loginEmail = document.getElementById('login-email');
    const loginPass = document.getElementById('login-pass');
    const resetBtn  = document.getElementById('reset-btn');

    const signOutBtn = document.getElementById('signout-btn');

    const dock = document.getElementById('dock');
    const dockButtons = document.getElementById('dock-buttons');
    const dockPanel = document.getElementById('dock-panel');
    const dockTitle = document.getElementById('dock-title');
    const dockContent = document.getElementById('dock-content');

    const btnFriends  = document.getElementById('btn-friends');
    const btnSearch   = document.getElementById('btn-search');
    const btnProfile  = document.getElementById('btn-profile');
    const btnThemes   = document.getElementById('btn-themes');

    // ------- MAPA -------
    let map, userMarker;
    function initMap() {
      map = L.map('map').setView([46.0569, 14.5058], 13); // Ljubljana privzeto
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const { latitude, longitude } = pos.coords;
          map.setView([latitude, longitude], 14);
          userMarker = L.marker([latitude, longitude]).addTo(map).bindPopup('Ti si tukaj');
        });
      }
    }

    // ------- POMO≈ΩNE FUNKCIJE -------
    const q = sel => document.querySelector(sel);
    const el = (tag, cls, txt) => {
      const e = document.createElement(tag);
      if (cls) e.className = cls;
      if (txt) e.textContent = txt;
      return e;
    };
    function toast(msg, type='info') {
      const t = el('div', `toast ${type}`, msg);
      document.body.appendChild(t);
      setTimeout(() => t.classList.add('show'), 10);
      setTimeout(() => { t.classList.remove('show'); t.remove(); }, 3000);
    }

    // ------- TEMA -------
    const THEMES = [
      // 8 tem, definirane kot CSS var v :root in .theme-X
      'theme-default', 'theme-ocean', 'theme-sunset', 'theme-forest',
      'theme-grape', 'theme-coal', 'theme-snow', 'theme-lime'
    ];
    function applyTheme(theme) {
      document.documentElement.classList.remove(...THEMES);
      document.documentElement.classList.add(theme);
      localStorage.setItem('xlifer-theme', theme);
    }
    function cycleTheme() {
      const cur = localStorage.getItem('xlifer-theme') || THEMES[0];
      const idx = THEMES.indexOf(cur);
      const next = THEMES[(idx + 1) % THEMES.length];
      applyTheme(next);
    }

    // ------- AVTENTIKACIJA -------
    regForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = regName.value.trim();
      const email = regEmail.value.trim();
      const pass = regPass.value.trim();
      const dob  = regDob.value;
      if (!name || !email || !pass || !dob) return toast('Izpolni vsa polja', 'warn');
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(cred.user, { displayName: name });
        const userDoc = doc(db, 'users', cred.user.uid);
        await setDoc(userDoc, {
          uid: cred.user.uid,
          name,
          nameLower: name.toLowerCase(),
          email,
          dob,
          createdAt: serverTimestamp()
        });
        toast('Registracija uspe≈°na!');
      } catch (err) {
        console.error(err);
        toast(err.message, 'error');
      }
    });

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = loginEmail.value.trim();
      const pass  = loginPass.value.trim();
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (err) {
        console.error(err);
        toast(err.message, 'error');
      }
    });

    resetBtn.addEventListener('click', async () => {
      const email = loginEmail.value.trim();
      if (!email) return toast('Vpi≈°i e-po≈°to za ponastavitev.', 'warn');
      try {
        await sendPasswordResetEmail(auth, email);
        toast('Poslali smo e-po≈°to za ponastavitev gesla.');
      } catch (err) { toast(err.message, 'error'); }
    });

    signOutBtn.addEventListener('click', async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        authView.style.display = 'none';
        appView.style.display = 'block';
        initMap();
        loadFriends();
      } else {
        appView.style.display = 'none';
        authView.style.display = 'grid';
      }
    });

    // ------- DOCK OBNA≈†ANJE -------
    function openPanel(title, contentBuilder) {
      dock.classList.add('open');
      dockTitle.textContent = title;
      dockContent.innerHTML = '';
      contentBuilder(dockContent);
    }
    function closePanel() { dock.classList.remove('open'); }

    btnFriends.addEventListener('click', () => openPanel('Seznam prijateljev', buildFriendsPanel));
    btnSearch.addEventListener('click', () => openPanel('Iskanje prijateljev', buildSearchPanel));
    btnProfile.addEventListener('click', () => openPanel('Moj profil', buildProfilePanel));
    btnThemes.addEventListener('click', () => { cycleTheme(); });

    // ------- PRIJATELJI -------
    async function loadFriends() {
      const user = auth.currentUser; if (!user) return;
      const snap = await getDocs(collection(db, 'users', user.uid, 'friends'));
      const list = [];
      snap.forEach(d => list.push(d.data()));
      window.__friends = list; // za hiter dostop
      if (dock.classList.contains('open') && dockTitle.textContent.includes('Seznam')) {
        buildFriendsPanel(dockContent);
      }
    }

    function buildFriendsPanel(container) {
      const backBtn = el('button', 'ghost', 'Zapri');
      backBtn.addEventListener('click', closePanel);
      container.appendChild(backBtn);

      const ul = el('div', 'list');
      const friends = window.__friends || [];
      if (friends.length === 0) {
        ul.appendChild(el('div', 'muted', '≈†e nima≈° prijateljev. Poi≈°ƒçi jih v "Iskanje prijateljev".'));
      } else {
        friends.sort((a,b)=>a.name.localeCompare(b.name)).forEach(fr => {
          const row = el('div', 'row');
          row.appendChild(el('div', 'title', fr.name));
          row.appendChild(el('div', 'sub', fr.email));
          const chatBtn = el('button', 'primary', 'Odpri chat');
          chatBtn.addEventListener('click', () => openChat(fr.uid, fr.name));
          row.appendChild(chatBtn);
          ul.appendChild(row);
        });
      }
      container.appendChild(ul);
    }

    // ------- CHAT -------
    let unsubChat = null;
    function chatIdFor(u1, u2) { return [u1, u2].sort().join('_'); }

    function openChat(friendUid, friendName) {
      const user = auth.currentUser; if (!user) return;
      openPanel(`Chat z ${friendName}`, (container) => {
        const back = el('button', 'ghost', 'Nazaj');
        back.addEventListener('click', () => { if (unsubChat) unsubChat(); loadFriends(); buildFriendsPanel(dockContent); });
        container.appendChild(back);

        const messagesBox = el('div', 'messages');
        container.appendChild(messagesBox);

        const inputWrap = el('div', 'input-wrap');
        const input = el('input'); input.placeholder = 'Sporoƒçilo...';
        const sendBtn = el('button', 'primary', 'Po≈°lji');
        inputWrap.appendChild(input); inputWrap.appendChild(sendBtn);
        container.appendChild(inputWrap);

        const chatId = chatIdFor(user.uid, friendUid);
        const msgsCol = collection(db, 'chats', chatId, 'messages');
        const qMsgs = query(msgsCol, orderBy('createdAt'));
        if (unsubChat) unsubChat();
        unsubChat = onSnapshot(qMsgs, (snap) => {
          messagesBox.innerHTML = '';
          snap.forEach(docu => {
            const m = docu.data();
            const bubble = el('div', `bubble ${m.uid===user.uid?'me':'them'}`);
            bubble.textContent = m.text;
            messagesBox.appendChild(bubble);
          });
          messagesBox.scrollTop = messagesBox.scrollHeight;
        });

        async function send() {
          const text = input.value.trim(); if (!text) return;
          await addDoc(msgsCol, { text, uid: user.uid, createdAt: serverTimestamp() });
          input.value = '';
        }
        sendBtn.addEventListener('click', send);
        input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') send(); });
      });
    }

    // ------- ISKANJE PRIJATELJEV & ZAHTEVE -------
    function buildSearchPanel(container) {
      let mode = 'search'; // 'search' | 'requests'

      const head = el('div', 'search-head');
      const back = el('button', 'ghost', 'Nazaj'); back.addEventListener('click', closePanel);
      const toggle = el('button', 'secondary', 'Poka≈æi zahteve');
      head.appendChild(back);
      const input = el('input', 'search-input'); input.placeholder = 'Vpi≈°i ime (prefix)';
      head.appendChild(input);
      head.appendChild(toggle);
      container.appendChild(head);

      const area = el('div', 'list');
      container.appendChild(area);

      async function render() {
        area.innerHTML = '';
        const user = auth.currentUser; if (!user) return;
        if (mode === 'search') {
          const term = input.value.trim().toLowerCase();
          if (!term) { area.appendChild(el('div','muted','Zaƒçni z vnosom imena.')); return; }
          const usersRef = collection(db, 'users');
          const qUsers = query(usersRef, orderBy('nameLower'), startAt(term), endAt(term + '\uf8ff'), limit(20));
          const snap = await getDocs(qUsers);
          snap.forEach(d => {
            const u = d.data(); if (u.uid === user.uid) return;
            const row = el('div','row');
            row.appendChild(el('div','title', u.name));
            row.appendChild(el('div','sub', u.email));
            const btn = el('button','primary','Dodaj prijatelja');
            btn.addEventListener('click', ()=> sendFriendRequest(user.uid, u.uid));
            row.appendChild(btn);
            area.appendChild(row);
          });
          if (area.children.length===0) area.appendChild(el('div','muted','Ni zadetkov.'));
        } else {
          // zahtevki zame
          const reqsRef = collection(db, 'friendRequests');
          const qReq = query(reqsRef, where('to','==', auth.currentUser.uid), where('status','==','pending'), orderBy('createdAt'));
          const snap = await getDocs(qReq);
          snap.forEach(d => {
            const r = d.data();
            const row = el('div','row');
            const fromSpan = el('div','title', r.fromName || r.from);
            row.appendChild(fromSpan);
            const actions = el('div','actions');
            const accept = el('button','primary','Potrdi');
            const decline = el('button','ghost','Zavrni');
            accept.addEventListener('click', ()=> respondFriendRequest(d.id, r));
            decline.addEventListener('click', ()=> declineFriendRequest(d.id));
            actions.appendChild(accept); actions.appendChild(decline);
            row.appendChild(actions);
            area.appendChild(row);
          });
          if (area.children.length===0) area.appendChild(el('div','muted','Ni novih zahtev.'));
        }
      }

      input.addEventListener('input', () => { if (mode==='search') render(); });
      toggle.addEventListener('click', () => {
        mode = (mode==='search')? 'requests' : 'search';
        toggle.textContent = mode==='search' ? 'Poka≈æi zahteve' : 'Poka≈æi iskanje';
        render();
      });

      render();
    }

    async function sendFriendRequest(fromUid, toUid) {
      if (fromUid === toUid) return;
      const fromDoc = await getDoc(doc(db, 'users', fromUid));
      const toDoc   = await getDoc(doc(db, 'users', toUid));
      const data = {
        from: fromUid,
        to: toUid,
        fromName: fromDoc.exists()? fromDoc.data().name : 'Uporabnik',
        toName: toDoc.exists()? toDoc.data().name : 'Uporabnik',
        status: 'pending',
        createdAt: serverTimestamp()
      };
      await addDoc(collection(db, 'friendRequests'), data);
      toast('Zahteva poslana.');
    }

    async function respondFriendRequest(reqId, req) {
      const batch = writeBatch(db);
      const reqRef = doc(db, 'friendRequests', reqId);
      batch.update(reqRef, { status: 'accepted' });

      const aRef = doc(db, 'users', req.from, 'friends', req.to);
      const bRef = doc(db, 'users', req.to, 'friends', req.from);
      batch.set(aRef, { uid: req.to, name: req.toName, email: (await getDoc(doc(db,'users',req.to))).data().email });
      batch.set(bRef, { uid: req.from, name: req.fromName, email: (await getDoc(doc(db,'users',req.from))).data().email });

      await batch.commit();
      toast('Prijatelj potrjen.');
      loadFriends();
    }

    async function declineFriendRequest(reqId) {
      const reqRef = doc(db, 'friendRequests', reqId);
      await updateDoc(reqRef, { status: 'declined' });
      toast('Zahteva zavrnjena.');
    }

    // ------- PROFIL -------
    function buildProfilePanel(container) {
      const user = auth.currentUser; if (!user) return;
      const back = el('button','ghost','Nazaj'); back.addEventListener('click', closePanel);
      container.appendChild(back);

      const card = el('div','card');
      const name = el('div','big', user.displayName || 'Brez imena');
      const email = el('div','sub', user.email);
      card.appendChild(name); card.appendChild(email);

      // pridobi datum rojstva iz Firestore
      (async () => {
        const udoc = await getDoc(doc(db,'users', user.uid));
        const dob = udoc.exists()? (udoc.data().dob||'Ni podatka') : 'Ni podatka';
        const dobEl = el('div','sub', 'Datum rojstva: ' + dob);
        card.appendChild(dobEl);
      })();

      const row = el('div','row');
      const out = el('button','secondary','Odjava');
      out.addEventListener('click', ()=> signOut(auth));
      row.appendChild(out);
      card.appendChild(row);

      container.appendChild(card);
    }

    // ------- INIT THEMA & UI -------
    applyTheme(localStorage.getItem('xlifer-theme') || THEMES[0]);

    // Prika≈æi ime polje v prijavi (neobvezno za Firebase, a ga hranimo zaradi tvoje zahteve)
    loginName.addEventListener('input', () => {/* polje obstaja vizualno */});

  </script>

  <style>
    :root{
      --bg: #0b0f14; --fg:#e9f0f7; --muted:#9fb3c8; --primary:#4dabf7; --secondary:#556581; --dock:#10151d; --card:#131a24; --me:#2b8a3e; --them:#2b4c7e;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    .theme-default:root{}
    .theme-ocean:root{ --primary:#2ab3bf; --card:#0e1a21; --dock:#0b141a; }
    .theme-sunset:root{ --primary:#ff7a59; --card:#1d1412; --dock:#15100f; }
    .theme-forest:root{ --primary:#4caf50; --card:#121912; --dock:#0d120d; }
    .theme-grape:root{ --primary:#8e44ad; --card:#191223; --dock:#120d1a; }
    .theme-coal:root{ --bg:#0b0b0b; --fg:#f1f1f1; --muted:#bdbdbd; --primary:#888; --card:#111; --dock:#0d0d0d; }
    .theme-snow:root{ --bg:#fafafa; --fg:#0b0f14; --muted:#4b5868; --primary:#0057ff; --card:#ffffff; --dock:#f4f6f8; }
    .theme-lime:root{ --primary:#9acd32; --card:#101812; --dock:#0c120d; }

    html, body { height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--fg); font: 15px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    *{ box-sizing: border-box; }

    /* AUTH VIEW */
    #auth-view{
      display:grid; place-items:center; gap:24px; min-height:100dvh; padding:24px;
    }
    .auth-card{ width:min(560px, 100%); background:var(--card); padding:20px; border-radius:var(--radius); box-shadow:var(--shadow); }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    input{ width:100%; padding:10px 12px; border:1px solid #0000; border-radius:12px; background:#0f1723; color:var(--fg); outline:none; }
    input:focus{ border-color: var(--primary); }
    .row{ display:flex; align-items:center; gap:10px; justify-content:space-between; }
    .actions{ display:flex; gap:8px; }
    .btn, button{ cursor:pointer; border:none; border-radius:12px; padding:10px 14px; }
    .primary{ background:var(--primary); color:#fff; }
    .secondary{ background:#223046; color:#fff; }
    .ghost{ background:transparent; color:var(--fg); border:1px solid #2a3446; }
    .muted{ color:var(--muted); }
    .big{ font-weight:700; font-size:18px; }

    a{ color:var(--primary); text-decoration:none; }

    /* APP VIEW */
    #app-view{ display:none; height:100dvh; }
    #map{ height:100%; width:100%; }

    /* DOCK */
    #dock{
      position:fixed; left:50%; transform:translateX(-50%); z-index:999;
      bottom:30px; width:90%; background:var(--dock); border-radius:20px; box-shadow:var(--shadow);
      overflow:hidden; transition:height .25s ease, padding .25s ease; height: 20px; display:flex; flex-direction:column;
    }
    #dock.open{ height: min(90vh, 620px); }
    #dock-buttons{ display:flex; gap:8px; padding:6px; justify-content:center; align-items:center; flex-wrap:wrap; }
    #dock-buttons button{ height:32px; padding:0 12px; }

    #dock-panel{ margin-top:auto; display:flex; flex-direction:column; height:100%; }
    #dock-header{ padding:10px 12px; border-top:1px solid #223046; display:flex; align-items:center; justify-content:space-between; }
    #dock-title{ font-weight:700; }
    #dock-content{ padding:12px; overflow:auto; }

    .list{ display:flex; flex-direction:column; gap:10px; }
    .card{ background:var(--card); border-radius:var(--radius); padding:14px; }
    .title{ font-weight:600; }
    .sub{ color:var(--muted); font-size:12px; }

    .messages{ display:flex; flex-direction:column; gap:6px; max-height:40vh; overflow:auto; background:#0f1723; padding:12px; border-radius:12px; }
    .bubble{ max-width:75%; padding:8px 10px; border-radius:12px; }
    .bubble.me{ background:var(--me); align-self:flex-end; color:#fff; }
    .bubble.them{ background:var(--them); align-self:flex-start; color:#fff; }
    .input-wrap{ display:flex; gap:8px; margin-top:8px; }
    .input-wrap input{ flex:1; }

    .search-head{ display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    .search-input{ flex:1; }

    .toast{ position:fixed; left:50%; transform:translateX(-50%) translateY(10px); bottom:20px; background:#111a; color:#fff; padding:10px 14px; border-radius:12px; opacity:0; transition:all .2s; backdrop-filter: blur(6px); }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

    @media (max-width:700px){
      .grid{ grid-template-columns:1fr; }
      #dock{ width:94%; }
      .auth-card{ padding:16px; }
    }
  </style>
</head>
<body>
  <!-- AUTH -->
  <div id="auth-view">
    <div class="auth-card">
      <h2>Registracija</h2>
      <form id="reg-form">
        <div class="grid">
          <div>
            <label>Ime in priimek</label>
            <input id="reg-name" type="text" autocomplete="name" required />
          </div>
          <div>
            <label>E-po≈°ta</label>
            <input id="reg-email" type="email" autocomplete="email" required />
          </div>
          <div>
            <label>Geslo</label>
            <input id="reg-pass" type="password" autocomplete="new-password" minlength="6" required />
          </div>
          <div>
            <label>Datum rojstva</label>
            <input id="reg-dob" type="date" required />
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <div class="muted">Z registracijo se ustvari tudi tvoj profil.</div>
          <button class="primary" type="submit">Ustvari raƒçun</button>
        </div>
      </form>
    </div>

    <div class="auth-card">
      <h2>Prijava</h2>
      <form id="login-form">
        <div class="grid">
          <div>
            <label>Ime (neobvezno)</label>
            <input id="login-name" type="text" autocomplete="nickname" />
          </div>
          <div>
            <label>E-po≈°ta</label>
            <input id="login-email" type="email" autocomplete="email" required />
          </div>
          <div>
            <label>Geslo</label>
            <input id="login-pass" type="password" autocomplete="current-password" required />
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <button id="reset-btn" class="ghost" type="button">Pozabljeno geslo</button>
          <button class="primary" type="submit">Prijava</button>
        </div>
      </form>
    </div>
  </div>

  <!-- APP -->
  <div id="app-view">
    <div id="map"></div>

    <div id="dock">
      <div id="dock-buttons">
        <button id="btn-friends" class="secondary">Seznam prijateljev</button>
        <button id="btn-search" class="secondary">Iskanje prijateljev</button>
        <button id="btn-profile" class="secondary">Moj profil</button>
        <button id="btn-themes" class="secondary">Tema (8)</button>
        <button id="signout-btn" class="ghost" title="Odjava">‚éã</button>
      </div>
      <div id="dock-panel">
        <div id="dock-header">
          <div id="dock-title"></div>
        </div>
        <div id="dock-content"></div>
      </div>
    </div>
  </div>
</body>
</html>
